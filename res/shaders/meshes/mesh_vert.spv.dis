; SPIR-V
; Version: 1.6
; Generator: Khronos Glslang Reference Front End; 11
; Bound: 259
; Schema: 0
               OpCapability Shader
               OpCapability Int64
               OpCapability DrawParameters
               OpCapability PhysicalStorageBufferAddresses
          %3 = OpExtInstImport "GLSL.std.450"
               OpMemoryModel PhysicalStorageBuffer64 GLSL450
               OpEntryPoint Vertex %main "main" %vDrawID %gl_DrawIDARB %drawData %_ %vInstanceID %gl_InstanceIndex %gl_VertexIndex %__0 %outWorldPos %__1 %__2 %outNormal %outColor %outUV
          %1 = OpString "C:\\Users\\Justi\\source\\repos\\VulkanRenderer\\VulkanRenderer\\res\\shaders\\meshes\\mesh_vert.vert"
          %2 = OpString "C:/Users/Justi/source/repos/VulkanRenderer/VulkanRenderer/res/shaders/meshes/../include/gpu_scene_structures.glsl"
               OpSource GLSL 450 %1 "#version 450

#extension GL_ARB_shader_draw_parameters : require
#extension GL_EXT_buffer_reference : require
#extension GL_EXT_scalar_block_layout : require
#extension GL_ARB_gpu_shader_int64 : require
#extension GL_GOOGLE_include_directive : require
#extension GL_ARB_separate_shader_objects : require
#extension GL_EXT_nonuniform_qualifier : require

#include \"../include/gpu_scene_structures.glsl\"

layout(location = 0) out vec3 outNormal;
layout(location = 1) out vec3 outColor;
layout(location = 2) out vec2 outUV;
layout(location = 3) out vec3 outWorldPos;
layout(location = 4) flat out uint vDrawID;
layout(location = 5) flat out uint vInstanceID;

layout(set = 0, binding = 0, scalar) readonly buffer GlobalAddressTableBuffer {
    GPUAddressTable globalAddressTable;
};

layout(set = 1, binding = 0, scalar) readonly buffer FrameAddressTableBuffer {
    GPUAddressTable frameAddressTable;
};

layout(set = 1, binding = 1) uniform SceneUBO {
    SceneData scene;
};

layout(push_constant) uniform DrawPushConstants {
	uint opaqueDrawCount;
	uint transparentDrawCount;
	uint totalVertexCount;
	uint totalIndexCount;
} drawData;

void main() {
    vDrawID = gl_DrawIDARB;

    IndirectDrawCmd drawCmd;
    Instance inst;

    if (vDrawID < drawData.opaqueDrawCount) {
        // opaque
        OpaqueIndirectDraws cmdBuf = OpaqueIndirectDraws(frameAddressTable.addrs[ABT_OpaqueIndirectDraws]);
        OpaqueInstances instBuf = OpaqueInstances(frameAddressTable.addrs[ABT_OpaqueInstances]);

        drawCmd     = cmdBuf.opaqueIndirect[vDrawID];
        vInstanceID = drawCmd.firstInstance + gl_InstanceIndex;
        inst        = instBuf.opaqueInstances[vInstanceID];
    } else {
        // transparent
        uint tIndex = vDrawID - drawData.opaqueDrawCount;
        if (tIndex >= drawData.transparentDrawCount) return;

        TransparentIndirectDraws cmdBuf = TransparentIndirectDraws(frameAddressTable.addrs[ABT_TransparentIndirectDraws]);
        TransparentInstances instBuf = TransparentInstances(frameAddressTable.addrs[ABT_TransparentInstances]);

        drawCmd     = cmdBuf.transparentIndirect[tIndex];
        vInstanceID = drawCmd.firstInstance + gl_InstanceIndex;
        inst        = instBuf.transparentInstances[vInstanceID];
    }

    uint vertIdx = gl_VertexIndex;
    if (vertIdx >= drawData.totalVertexCount) return;

    // fetch the vertex
    VertexBuffer vertexBuf = VertexBuffer(globalAddressTable.addrs[ABT_Vertex]);
    Vertex vtx = vertexBuf.vertices[vertIdx];

    // fetch transform
    TransformsListBuffer transformsBuffer = TransformsListBuffer(frameAddressTable.addrs[ABT_Transforms]);
    mat4 model = transformsBuffer.transforms[inst.transformID];

    vec4 worldPos4 = model * vec4(vtx.position, 1.0);
    outWorldPos  = worldPos4.xyz;
    gl_Position = scene.viewproj * worldPos4;

    mat3 normalMatrix = transpose(inverse(mat3(model)));
    outNormal = normalize(normalMatrix * vtx.normal);
    outColor = vtx.color.xyz;
    outUV = vtx.uv;
}"
               OpSource GLSL 450 %2 "#extension GL_EXT_buffer_reference : require
#extension GL_EXT_scalar_block_layout : require
#extension GL_ARB_gpu_shader_int64 : require

#ifndef GPU_SCENE_STRUCTURES_GLSL
#define GPU_SCENE_STRUCTURES_GLSL

struct SceneData {
    mat4 view;
    mat4 proj;
    mat4 viewproj;
    vec4 ambientColor;
    vec4 sunlightDirection; // .w = power
    vec4 sunlightColor;
    vec4 cameraPos;
};

// Number of env sets stored in the buffer (must match C++ side)
const uint MAX_ENV_SETS = 16u;

struct EnvMapBindingSet {
    vec4 mapIndices[MAX_ENV_SETS];
    // x = diffuseMapIndex
    // y = specularMapIndex
    // z = brdfLUTIndex
    // w = skyboxMapIndex
};

struct AABB {
	vec3 vmin; // origin: 0.5f * (vmin + vmax)
	vec3 vmax; // extent: 0.5f * (vmax - vmin)
	vec3 origin;
	vec3 extent;
	float sphereRadius;
};

struct Vertex {
    vec3 position;
    vec3 normal;
    vec2 uv;
    vec4 color;
};


struct Material {
    vec4 colorFactor;
    vec2 metalRoughFactors;

    uint albedoLUTIndex;
    uint metalRoughLUTIndex;
    uint normalLUTIndex;
    uint aoLUTIndex;

    vec3 emissiveColor;
    float emissiveStrength;

    float ambientOcclusion;
    float normalScale;
    float alphaCutoff;
    uint passType;
};

struct Mesh {
    AABB localAABB;
    AABB worldAABB;
    uint drawRangeID;
};


struct Instance {
    uint instanceID;
    uint materialID;
    uint meshID;
    uint transformID;
};

// Enum address buffer types
const uint ABT_OpaqueInstances          = 0u; // frame
const uint ABT_OpaqueIndirectDraws      = 1u; // frame
const uint ABT_TransparentInstances     = 2u; // frame
const uint ABT_TransparentIndirectDraws = 3u; // frame
const uint ABT_Material                 = 4u; // global
const uint ABT_Mesh                     = 5u; // global
const uint ABT_DrawRange                = 6u; // global
const uint ABT_Vertex                   = 7u; // global
const uint ABT_Index                    = 8u; // global
const uint ABT_Transforms               = 9u; // frame
const uint ABT_VisibleCount             = 10u; // frame
const uint ABT_VisibleMeshIDs           = 11u; // frame
const uint ABT_Count                    = 12u;

struct GPUAddressTable {
    uint64_t addrs[ABT_Count];
};

struct GPUDrawRange {
    uint firstIndex;
    uint indexCount;
    uint vertexOffset;
    uint vertexCount;
};

struct IndirectDrawCmd {
    uint indexCount;
    uint instanceCount;
    uint firstIndex;
    int vertexOffset;
    uint firstInstance;
};

// GPU-only buffers

// Opaque and transparent data is a render time upload
// Only visible data makes it through

// Opaque
layout(buffer_reference, scalar) readonly buffer OpaqueInstances {
    Instance opaqueInstances[];
};
layout(buffer_reference, scalar) readonly buffer OpaqueIndirectDraws {
    IndirectDrawCmd opaqueIndirect[];
};

// Transparent
layout(buffer_reference, scalar) readonly buffer TransparentInstances {
    Instance transparentInstances[];
};
layout(buffer_reference, scalar) readonly buffer TransparentIndirectDraws {
    IndirectDrawCmd transparentIndirect[];
};

// ranges, materials, vertices, indices, all ready at render time and uploaded at end of asset loading
layout(buffer_reference, scalar) readonly buffer DrawRangeBuffer {
    GPUDrawRange ranges[];
};

layout(buffer_reference, scalar) readonly buffer MaterialBuffer {
    Material materials[];
};

layout(buffer_reference, scalar) readonly buffer VertexBuffer {
    Vertex vertices[];
};

layout(buffer_reference, scalar) readonly buffer IndexBuffer {
    uint indices[];
};

layout(buffer_reference, scalar) readonly buffer TransformsListBuffer {
    mat4 transforms[];
};

// In current cpu based setup, worldAABBs are done on cpu after main upload,
// all thats present here currently is localAABB and drawRangeIndex
layout(buffer_reference, scalar) readonly buffer MeshBuffer {
    Mesh meshes[];
};


// Inactives
layout(buffer_reference, scalar) writeonly buffer VisibleCountBuffer {
    uint visibleCount;
};

layout(buffer_reference, scalar) writeonly buffer VisibleMeshIDBuffer {
    uint visibleMeshIDs[];
};

#endif"
               OpSourceExtension "GL_ARB_gpu_shader_int64"
               OpSourceExtension "GL_ARB_separate_shader_objects"
               OpSourceExtension "GL_ARB_shader_draw_parameters"
               OpSourceExtension "GL_EXT_buffer_reference"
               OpSourceExtension "GL_EXT_nonuniform_qualifier"
               OpSourceExtension "GL_EXT_scalar_block_layout"
               OpSourceExtension "GL_GOOGLE_cpp_style_line_directive"
               OpSourceExtension "GL_GOOGLE_include_directive"
               OpName %main "main"
               OpName %vDrawID "vDrawID"
               OpName %gl_DrawIDARB "gl_DrawIDARB"
               OpName %DrawPushConstants "DrawPushConstants"
               OpMemberName %DrawPushConstants 0 "opaqueDrawCount"
               OpMemberName %DrawPushConstants 1 "transparentDrawCount"
               OpMemberName %DrawPushConstants 2 "totalVertexCount"
               OpMemberName %DrawPushConstants 3 "totalIndexCount"
               OpName %drawData "drawData"
               OpName %IndirectDrawCmd "IndirectDrawCmd"
               OpMemberName %IndirectDrawCmd 0 "indexCount"
               OpMemberName %IndirectDrawCmd 1 "instanceCount"
               OpMemberName %IndirectDrawCmd 2 "firstIndex"
               OpMemberName %IndirectDrawCmd 3 "vertexOffset"
               OpMemberName %IndirectDrawCmd 4 "firstInstance"
               OpName %OpaqueIndirectDraws "OpaqueIndirectDraws"
               OpMemberName %OpaqueIndirectDraws 0 "opaqueIndirect"
               OpName %cmdBuf "cmdBuf"
               OpName %GPUAddressTable "GPUAddressTable"
               OpMemberName %GPUAddressTable 0 "addrs"
               OpName %FrameAddressTableBuffer "FrameAddressTableBuffer"
               OpMemberName %FrameAddressTableBuffer 0 "frameAddressTable"
               OpName %_ ""
               OpName %Instance "Instance"
               OpMemberName %Instance 0 "instanceID"
               OpMemberName %Instance 1 "materialID"
               OpMemberName %Instance 2 "meshID"
               OpMemberName %Instance 3 "transformID"
               OpName %OpaqueInstances "OpaqueInstances"
               OpMemberName %OpaqueInstances 0 "opaqueInstances"
               OpName %instBuf "instBuf"
               OpName %IndirectDrawCmd_0 "IndirectDrawCmd"
               OpMemberName %IndirectDrawCmd_0 0 "indexCount"
               OpMemberName %IndirectDrawCmd_0 1 "instanceCount"
               OpMemberName %IndirectDrawCmd_0 2 "firstIndex"
               OpMemberName %IndirectDrawCmd_0 3 "vertexOffset"
               OpMemberName %IndirectDrawCmd_0 4 "firstInstance"
               OpName %drawCmd "drawCmd"
               OpName %vInstanceID "vInstanceID"
               OpName %gl_InstanceIndex "gl_InstanceIndex"
               OpName %Instance_0 "Instance"
               OpMemberName %Instance_0 0 "instanceID"
               OpMemberName %Instance_0 1 "materialID"
               OpMemberName %Instance_0 2 "meshID"
               OpMemberName %Instance_0 3 "transformID"
               OpName %inst "inst"
               OpName %tIndex "tIndex"
               OpName %IndirectDrawCmd_1 "IndirectDrawCmd"
               OpMemberName %IndirectDrawCmd_1 0 "indexCount"
               OpMemberName %IndirectDrawCmd_1 1 "instanceCount"
               OpMemberName %IndirectDrawCmd_1 2 "firstIndex"
               OpMemberName %IndirectDrawCmd_1 3 "vertexOffset"
               OpMemberName %IndirectDrawCmd_1 4 "firstInstance"
               OpName %TransparentIndirectDraws "TransparentIndirectDraws"
               OpMemberName %TransparentIndirectDraws 0 "transparentIndirect"
               OpName %cmdBuf_0 "cmdBuf"
               OpName %Instance_1 "Instance"
               OpMemberName %Instance_1 0 "instanceID"
               OpMemberName %Instance_1 1 "materialID"
               OpMemberName %Instance_1 2 "meshID"
               OpMemberName %Instance_1 3 "transformID"
               OpName %TransparentInstances "TransparentInstances"
               OpMemberName %TransparentInstances 0 "transparentInstances"
               OpName %instBuf_0 "instBuf"
               OpName %vertIdx "vertIdx"
               OpName %gl_VertexIndex "gl_VertexIndex"
               OpName %Vertex "Vertex"
               OpMemberName %Vertex 0 "position"
               OpMemberName %Vertex 1 "normal"
               OpMemberName %Vertex 2 "uv"
               OpMemberName %Vertex 3 "color"
               OpName %VertexBuffer "VertexBuffer"
               OpMemberName %VertexBuffer 0 "vertices"
               OpName %vertexBuf "vertexBuf"
               OpName %GlobalAddressTableBuffer "GlobalAddressTableBuffer"
               OpMemberName %GlobalAddressTableBuffer 0 "globalAddressTable"
               OpName %__0 ""
               OpName %Vertex_0 "Vertex"
               OpMemberName %Vertex_0 0 "position"
               OpMemberName %Vertex_0 1 "normal"
               OpMemberName %Vertex_0 2 "uv"
               OpMemberName %Vertex_0 3 "color"
               OpName %vtx "vtx"
               OpName %TransformsListBuffer "TransformsListBuffer"
               OpMemberName %TransformsListBuffer 0 "transforms"
               OpName %transformsBuffer "transformsBuffer"
               OpName %model "model"
               OpName %worldPos4 "worldPos4"
               OpName %outWorldPos "outWorldPos"
               OpName %gl_PerVertex "gl_PerVertex"
               OpMemberName %gl_PerVertex 0 "gl_Position"
               OpMemberName %gl_PerVertex 1 "gl_PointSize"
               OpMemberName %gl_PerVertex 2 "gl_ClipDistance"
               OpMemberName %gl_PerVertex 3 "gl_CullDistance"
               OpName %__1 ""
               OpName %SceneData "SceneData"
               OpMemberName %SceneData 0 "view"
               OpMemberName %SceneData 1 "proj"
               OpMemberName %SceneData 2 "viewproj"
               OpMemberName %SceneData 3 "ambientColor"
               OpMemberName %SceneData 4 "sunlightDirection"
               OpMemberName %SceneData 5 "sunlightColor"
               OpMemberName %SceneData 6 "cameraPos"
               OpName %SceneUBO "SceneUBO"
               OpMemberName %SceneUBO 0 "scene"
               OpName %__2 ""
               OpName %normalMatrix "normalMatrix"
               OpName %outNormal "outNormal"
               OpName %outColor "outColor"
               OpName %outUV "outUV"
               OpModuleProcessed "client vulkan100"
               OpModuleProcessed "target-env spirv1.6"
               OpModuleProcessed "target-env vulkan1.4"
               OpModuleProcessed "entry-point main"
               OpDecorate %vDrawID Flat
               OpDecorate %vDrawID Location 4
               OpDecorate %gl_DrawIDARB BuiltIn DrawIndex
               OpDecorate %DrawPushConstants Block
               OpMemberDecorate %DrawPushConstants 0 Offset 0
               OpMemberDecorate %DrawPushConstants 1 Offset 4
               OpMemberDecorate %DrawPushConstants 2 Offset 8
               OpMemberDecorate %DrawPushConstants 3 Offset 12
               OpMemberDecorate %IndirectDrawCmd 0 Offset 0
               OpMemberDecorate %IndirectDrawCmd 1 Offset 4
               OpMemberDecorate %IndirectDrawCmd 2 Offset 8
               OpMemberDecorate %IndirectDrawCmd 3 Offset 12
               OpMemberDecorate %IndirectDrawCmd 4 Offset 16
               OpDecorate %_runtimearr_IndirectDrawCmd ArrayStride 20
               OpDecorate %OpaqueIndirectDraws Block
               OpMemberDecorate %OpaqueIndirectDraws 0 NonWritable
               OpMemberDecorate %OpaqueIndirectDraws 0 Offset 0
               OpDecorate %cmdBuf AliasedPointer
               OpDecorate %_arr_ulong_uint_12 ArrayStride 8
               OpMemberDecorate %GPUAddressTable 0 Offset 0
               OpDecorate %FrameAddressTableBuffer Block
               OpMemberDecorate %FrameAddressTableBuffer 0 NonWritable
               OpMemberDecorate %FrameAddressTableBuffer 0 Offset 0
               OpDecorate %_ NonWritable
               OpDecorate %_ Binding 0
               OpDecorate %_ DescriptorSet 1
               OpMemberDecorate %Instance 0 Offset 0
               OpMemberDecorate %Instance 1 Offset 4
               OpMemberDecorate %Instance 2 Offset 8
               OpMemberDecorate %Instance 3 Offset 12
               OpDecorate %_runtimearr_Instance ArrayStride 16
               OpDecorate %OpaqueInstances Block
               OpMemberDecorate %OpaqueInstances 0 NonWritable
               OpMemberDecorate %OpaqueInstances 0 Offset 0
               OpDecorate %instBuf AliasedPointer
               OpDecorate %vInstanceID Flat
               OpDecorate %vInstanceID Location 5
               OpDecorate %gl_InstanceIndex BuiltIn InstanceIndex
               OpMemberDecorate %IndirectDrawCmd_1 0 Offset 0
               OpMemberDecorate %IndirectDrawCmd_1 1 Offset 4
               OpMemberDecorate %IndirectDrawCmd_1 2 Offset 8
               OpMemberDecorate %IndirectDrawCmd_1 3 Offset 12
               OpMemberDecorate %IndirectDrawCmd_1 4 Offset 16
               OpDecorate %_runtimearr_IndirectDrawCmd_1 ArrayStride 20
               OpDecorate %TransparentIndirectDraws Block
               OpMemberDecorate %TransparentIndirectDraws 0 NonWritable
               OpMemberDecorate %TransparentIndirectDraws 0 Offset 0
               OpDecorate %cmdBuf_0 AliasedPointer
               OpMemberDecorate %Instance_1 0 Offset 0
               OpMemberDecorate %Instance_1 1 Offset 4
               OpMemberDecorate %Instance_1 2 Offset 8
               OpMemberDecorate %Instance_1 3 Offset 12
               OpDecorate %_runtimearr_Instance_1 ArrayStride 16
               OpDecorate %TransparentInstances Block
               OpMemberDecorate %TransparentInstances 0 NonWritable
               OpMemberDecorate %TransparentInstances 0 Offset 0
               OpDecorate %instBuf_0 AliasedPointer
               OpDecorate %gl_VertexIndex BuiltIn VertexIndex
               OpMemberDecorate %Vertex 0 Offset 0
               OpMemberDecorate %Vertex 1 Offset 12
               OpMemberDecorate %Vertex 2 Offset 24
               OpMemberDecorate %Vertex 3 Offset 32
               OpDecorate %_runtimearr_Vertex ArrayStride 48
               OpDecorate %VertexBuffer Block
               OpMemberDecorate %VertexBuffer 0 NonWritable
               OpMemberDecorate %VertexBuffer 0 Offset 0
               OpDecorate %vertexBuf AliasedPointer
               OpDecorate %GlobalAddressTableBuffer Block
               OpMemberDecorate %GlobalAddressTableBuffer 0 NonWritable
               OpMemberDecorate %GlobalAddressTableBuffer 0 Offset 0
               OpDecorate %__0 NonWritable
               OpDecorate %__0 Binding 0
               OpDecorate %__0 DescriptorSet 0
               OpDecorate %_runtimearr_mat4v4float ArrayStride 64
               OpDecorate %TransformsListBuffer Block
               OpMemberDecorate %TransformsListBuffer 0 ColMajor
               OpMemberDecorate %TransformsListBuffer 0 MatrixStride 16
               OpMemberDecorate %TransformsListBuffer 0 NonWritable
               OpMemberDecorate %TransformsListBuffer 0 Offset 0
               OpDecorate %transformsBuffer AliasedPointer
               OpDecorate %outWorldPos Location 3
               OpDecorate %gl_PerVertex Block
               OpMemberDecorate %gl_PerVertex 0 BuiltIn Position
               OpMemberDecorate %gl_PerVertex 1 BuiltIn PointSize
               OpMemberDecorate %gl_PerVertex 2 BuiltIn ClipDistance
               OpMemberDecorate %gl_PerVertex 3 BuiltIn CullDistance
               OpMemberDecorate %SceneData 0 ColMajor
               OpMemberDecorate %SceneData 0 MatrixStride 16
               OpMemberDecorate %SceneData 0 Offset 0
               OpMemberDecorate %SceneData 1 ColMajor
               OpMemberDecorate %SceneData 1 MatrixStride 16
               OpMemberDecorate %SceneData 1 Offset 64
               OpMemberDecorate %SceneData 2 ColMajor
               OpMemberDecorate %SceneData 2 MatrixStride 16
               OpMemberDecorate %SceneData 2 Offset 128
               OpMemberDecorate %SceneData 3 Offset 192
               OpMemberDecorate %SceneData 4 Offset 208
               OpMemberDecorate %SceneData 5 Offset 224
               OpMemberDecorate %SceneData 6 Offset 240
               OpDecorate %SceneUBO Block
               OpMemberDecorate %SceneUBO 0 Offset 0
               OpDecorate %__2 Binding 1
               OpDecorate %__2 DescriptorSet 1
               OpDecorate %outNormal Location 0
               OpDecorate %outColor Location 1
               OpDecorate %outUV Location 2
       %void = OpTypeVoid
          %5 = OpTypeFunction %void
       %uint = OpTypeInt 32 0
%_ptr_Output_uint = OpTypePointer Output %uint
    %vDrawID = OpVariable %_ptr_Output_uint Output
        %int = OpTypeInt 32 1
%_ptr_Input_int = OpTypePointer Input %int
%gl_DrawIDARB = OpVariable %_ptr_Input_int Input
%DrawPushConstants = OpTypeStruct %uint %uint %uint %uint
%_ptr_PushConstant_DrawPushConstants = OpTypePointer PushConstant %DrawPushConstants
   %drawData = OpVariable %_ptr_PushConstant_DrawPushConstants PushConstant
      %int_0 = OpConstant %int 0
%_ptr_PushConstant_uint = OpTypePointer PushConstant %uint
       %bool = OpTypeBool
               OpTypeForwardPointer %_ptr_PhysicalStorageBuffer_OpaqueIndirectDraws PhysicalStorageBuffer
%IndirectDrawCmd = OpTypeStruct %uint %uint %uint %int %uint
%_runtimearr_IndirectDrawCmd = OpTypeRuntimeArray %IndirectDrawCmd
%OpaqueIndirectDraws = OpTypeStruct %_runtimearr_IndirectDrawCmd
%_ptr_PhysicalStorageBuffer_OpaqueIndirectDraws = OpTypePointer PhysicalStorageBuffer %OpaqueIndirectDraws
%_ptr_Function__ptr_PhysicalStorageBuffer_OpaqueIndirectDraws = OpTypePointer Function %_ptr_PhysicalStorageBuffer_OpaqueIndirectDraws
      %ulong = OpTypeInt 64 0
    %uint_12 = OpConstant %uint 12
%_arr_ulong_uint_12 = OpTypeArray %ulong %uint_12
%GPUAddressTable = OpTypeStruct %_arr_ulong_uint_12
%FrameAddressTableBuffer = OpTypeStruct %GPUAddressTable
%_ptr_StorageBuffer_FrameAddressTableBuffer = OpTypePointer StorageBuffer %FrameAddressTableBuffer
          %_ = OpVariable %_ptr_StorageBuffer_FrameAddressTableBuffer StorageBuffer
      %int_1 = OpConstant %int 1
%_ptr_StorageBuffer_ulong = OpTypePointer StorageBuffer %ulong
               OpTypeForwardPointer %_ptr_PhysicalStorageBuffer_OpaqueInstances PhysicalStorageBuffer
   %Instance = OpTypeStruct %uint %uint %uint %uint
%_runtimearr_Instance = OpTypeRuntimeArray %Instance
%OpaqueInstances = OpTypeStruct %_runtimearr_Instance
%_ptr_PhysicalStorageBuffer_OpaqueInstances = OpTypePointer PhysicalStorageBuffer %OpaqueInstances
%_ptr_Function__ptr_PhysicalStorageBuffer_OpaqueInstances = OpTypePointer Function %_ptr_PhysicalStorageBuffer_OpaqueInstances
%IndirectDrawCmd_0 = OpTypeStruct %uint %uint %uint %int %uint
%_ptr_Function_IndirectDrawCmd_0 = OpTypePointer Function %IndirectDrawCmd_0
%_ptr_PhysicalStorageBuffer_IndirectDrawCmd = OpTypePointer PhysicalStorageBuffer %IndirectDrawCmd
%vInstanceID = OpVariable %_ptr_Output_uint Output
      %int_4 = OpConstant %int 4
%_ptr_Function_uint = OpTypePointer Function %uint
%gl_InstanceIndex = OpVariable %_ptr_Input_int Input
 %Instance_0 = OpTypeStruct %uint %uint %uint %uint
%_ptr_Function_Instance_0 = OpTypePointer Function %Instance_0
%_ptr_PhysicalStorageBuffer_Instance = OpTypePointer PhysicalStorageBuffer %Instance
               OpTypeForwardPointer %_ptr_PhysicalStorageBuffer_TransparentIndirectDraws PhysicalStorageBuffer
%IndirectDrawCmd_1 = OpTypeStruct %uint %uint %uint %int %uint
%_runtimearr_IndirectDrawCmd_1 = OpTypeRuntimeArray %IndirectDrawCmd_1
%TransparentIndirectDraws = OpTypeStruct %_runtimearr_IndirectDrawCmd_1
%_ptr_PhysicalStorageBuffer_TransparentIndirectDraws = OpTypePointer PhysicalStorageBuffer %TransparentIndirectDraws
%_ptr_Function__ptr_PhysicalStorageBuffer_TransparentIndirectDraws = OpTypePointer Function %_ptr_PhysicalStorageBuffer_TransparentIndirectDraws
      %int_3 = OpConstant %int 3
               OpTypeForwardPointer %_ptr_PhysicalStorageBuffer_TransparentInstances PhysicalStorageBuffer
 %Instance_1 = OpTypeStruct %uint %uint %uint %uint
%_runtimearr_Instance_1 = OpTypeRuntimeArray %Instance_1
%TransparentInstances = OpTypeStruct %_runtimearr_Instance_1
%_ptr_PhysicalStorageBuffer_TransparentInstances = OpTypePointer PhysicalStorageBuffer %TransparentInstances
%_ptr_Function__ptr_PhysicalStorageBuffer_TransparentInstances = OpTypePointer Function %_ptr_PhysicalStorageBuffer_TransparentInstances
      %int_2 = OpConstant %int 2
%_ptr_PhysicalStorageBuffer_IndirectDrawCmd_1 = OpTypePointer PhysicalStorageBuffer %IndirectDrawCmd_1
%_ptr_PhysicalStorageBuffer_Instance_1 = OpTypePointer PhysicalStorageBuffer %Instance_1
%gl_VertexIndex = OpVariable %_ptr_Input_int Input
               OpTypeForwardPointer %_ptr_PhysicalStorageBuffer_VertexBuffer PhysicalStorageBuffer
      %float = OpTypeFloat 32
    %v3float = OpTypeVector %float 3
    %v2float = OpTypeVector %float 2
    %v4float = OpTypeVector %float 4
     %Vertex = OpTypeStruct %v3float %v3float %v2float %v4float
%_runtimearr_Vertex = OpTypeRuntimeArray %Vertex
%VertexBuffer = OpTypeStruct %_runtimearr_Vertex
%_ptr_PhysicalStorageBuffer_VertexBuffer = OpTypePointer PhysicalStorageBuffer %VertexBuffer
%_ptr_Function__ptr_PhysicalStorageBuffer_VertexBuffer = OpTypePointer Function %_ptr_PhysicalStorageBuffer_VertexBuffer
%GlobalAddressTableBuffer = OpTypeStruct %GPUAddressTable
%_ptr_StorageBuffer_GlobalAddressTableBuffer = OpTypePointer StorageBuffer %GlobalAddressTableBuffer
        %__0 = OpVariable %_ptr_StorageBuffer_GlobalAddressTableBuffer StorageBuffer
      %int_7 = OpConstant %int 7
   %Vertex_0 = OpTypeStruct %v3float %v3float %v2float %v4float
%_ptr_Function_Vertex_0 = OpTypePointer Function %Vertex_0
%_ptr_PhysicalStorageBuffer_Vertex = OpTypePointer PhysicalStorageBuffer %Vertex
               OpTypeForwardPointer %_ptr_PhysicalStorageBuffer_TransformsListBuffer PhysicalStorageBuffer
%mat4v4float = OpTypeMatrix %v4float 4
%_runtimearr_mat4v4float = OpTypeRuntimeArray %mat4v4float
%TransformsListBuffer = OpTypeStruct %_runtimearr_mat4v4float
%_ptr_PhysicalStorageBuffer_TransformsListBuffer = OpTypePointer PhysicalStorageBuffer %TransformsListBuffer
%_ptr_Function__ptr_PhysicalStorageBuffer_TransformsListBuffer = OpTypePointer Function %_ptr_PhysicalStorageBuffer_TransformsListBuffer
      %int_9 = OpConstant %int 9
%_ptr_Function_mat4v4float = OpTypePointer Function %mat4v4float
%_ptr_PhysicalStorageBuffer_mat4v4float = OpTypePointer PhysicalStorageBuffer %mat4v4float
%_ptr_Function_v4float = OpTypePointer Function %v4float
%_ptr_Function_v3float = OpTypePointer Function %v3float
    %float_1 = OpConstant %float 1
%_ptr_Output_v3float = OpTypePointer Output %v3float
%outWorldPos = OpVariable %_ptr_Output_v3float Output
     %uint_1 = OpConstant %uint 1
%_arr_float_uint_1 = OpTypeArray %float %uint_1
%gl_PerVertex = OpTypeStruct %v4float %float %_arr_float_uint_1 %_arr_float_uint_1
%_ptr_Output_gl_PerVertex = OpTypePointer Output %gl_PerVertex
        %__1 = OpVariable %_ptr_Output_gl_PerVertex Output
  %SceneData = OpTypeStruct %mat4v4float %mat4v4float %mat4v4float %v4float %v4float %v4float %v4float
   %SceneUBO = OpTypeStruct %SceneData
%_ptr_Uniform_SceneUBO = OpTypePointer Uniform %SceneUBO
        %__2 = OpVariable %_ptr_Uniform_SceneUBO Uniform
%_ptr_Uniform_mat4v4float = OpTypePointer Uniform %mat4v4float
%_ptr_Output_v4float = OpTypePointer Output %v4float
%mat3v3float = OpTypeMatrix %v3float 3
%_ptr_Function_mat3v3float = OpTypePointer Function %mat3v3float
  %outNormal = OpVariable %_ptr_Output_v3float Output
   %outColor = OpVariable %_ptr_Output_v3float Output
%_ptr_Output_v2float = OpTypePointer Output %v2float
      %outUV = OpVariable %_ptr_Output_v2float Output
%_ptr_Function_v2float = OpTypePointer Function %v2float
    %uint_16 = OpConstant %uint 16
     %uint_0 = OpConstant %uint 0
     %uint_2 = OpConstant %uint 2
     %uint_3 = OpConstant %uint 3
     %uint_4 = OpConstant %uint 4
     %uint_5 = OpConstant %uint 5
     %uint_6 = OpConstant %uint 6
     %uint_7 = OpConstant %uint 7
     %uint_8 = OpConstant %uint 8
     %uint_9 = OpConstant %uint 9
    %uint_10 = OpConstant %uint 10
    %uint_11 = OpConstant %uint 11
               OpLine %1 39 11
       %main = OpFunction %void None %5
          %7 = OpLabel
     %cmdBuf = OpVariable %_ptr_Function__ptr_PhysicalStorageBuffer_OpaqueIndirectDraws Function
    %instBuf = OpVariable %_ptr_Function__ptr_PhysicalStorageBuffer_OpaqueInstances Function
    %drawCmd = OpVariable %_ptr_Function_IndirectDrawCmd_0 Function
       %inst = OpVariable %_ptr_Function_Instance_0 Function
     %tIndex = OpVariable %_ptr_Function_uint Function
   %cmdBuf_0 = OpVariable %_ptr_Function__ptr_PhysicalStorageBuffer_TransparentIndirectDraws Function
  %instBuf_0 = OpVariable %_ptr_Function__ptr_PhysicalStorageBuffer_TransparentInstances Function
    %vertIdx = OpVariable %_ptr_Function_uint Function
  %vertexBuf = OpVariable %_ptr_Function__ptr_PhysicalStorageBuffer_VertexBuffer Function
        %vtx = OpVariable %_ptr_Function_Vertex_0 Function
%transformsBuffer = OpVariable %_ptr_Function__ptr_PhysicalStorageBuffer_TransformsListBuffer Function
      %model = OpVariable %_ptr_Function_mat4v4float Function
  %worldPos4 = OpVariable %_ptr_Function_v4float Function
%normalMatrix = OpVariable %_ptr_Function_mat3v3float Function
               OpLine %1 40 0
         %14 = OpLoad %int %gl_DrawIDARB
         %15 = OpBitcast %uint %14
               OpStore %vDrawID %15
               OpLine %1 45 0
         %16 = OpLoad %uint %vDrawID
         %22 = OpAccessChain %_ptr_PushConstant_uint %drawData %int_0
         %23 = OpLoad %uint %22
         %25 = OpULessThan %bool %16 %23
               OpSelectionMerge %27 None
               OpBranchConditional %25 %26 %82
         %26 = OpLabel
               OpLine %1 47 0
         %43 = OpAccessChain %_ptr_StorageBuffer_ulong %_ %int_0 %int_0 %int_1
         %44 = OpLoad %ulong %43
         %45 = OpConvertUToPtr %_ptr_PhysicalStorageBuffer_OpaqueIndirectDraws %44
               OpStore %cmdBuf %45
               OpLine %1 48 0
         %52 = OpAccessChain %_ptr_StorageBuffer_ulong %_ %int_0 %int_0 %int_0
         %53 = OpLoad %ulong %52
         %54 = OpConvertUToPtr %_ptr_PhysicalStorageBuffer_OpaqueInstances %53
               OpStore %instBuf %54
               OpLine %1 50 0
         %58 = OpLoad %_ptr_PhysicalStorageBuffer_OpaqueIndirectDraws %cmdBuf
         %59 = OpLoad %uint %vDrawID
         %61 = OpAccessChain %_ptr_PhysicalStorageBuffer_IndirectDrawCmd %58 %int_0 %59
         %62 = OpLoad %IndirectDrawCmd %61 Aligned 4
         %63 = OpCopyLogical %IndirectDrawCmd_0 %62
               OpStore %drawCmd %63
               OpLine %1 51 0
         %67 = OpAccessChain %_ptr_Function_uint %drawCmd %int_4
         %68 = OpLoad %uint %67
         %70 = OpLoad %int %gl_InstanceIndex
         %71 = OpBitcast %uint %70
         %72 = OpIAdd %uint %68 %71
               OpStore %vInstanceID %72
               OpLine %1 52 0
         %76 = OpLoad %_ptr_PhysicalStorageBuffer_OpaqueInstances %instBuf
         %77 = OpLoad %uint %vInstanceID
         %79 = OpAccessChain %_ptr_PhysicalStorageBuffer_Instance %76 %int_0 %77
         %80 = OpLoad %Instance %79 Aligned 16
         %81 = OpCopyLogical %Instance_0 %80
               OpStore %inst %81
               OpBranch %27
         %82 = OpLabel
               OpLine %1 55 0
         %84 = OpLoad %uint %vDrawID
         %85 = OpAccessChain %_ptr_PushConstant_uint %drawData %int_0
         %86 = OpLoad %uint %85
         %87 = OpISub %uint %84 %86
               OpStore %tIndex %87
               OpLine %1 56 0
         %88 = OpLoad %uint %tIndex
         %89 = OpAccessChain %_ptr_PushConstant_uint %drawData %int_1
         %90 = OpLoad %uint %89
         %91 = OpUGreaterThanEqual %bool %88 %90
               OpSelectionMerge %93 None
               OpBranchConditional %91 %92 %93
         %92 = OpLabel
               OpLine %1 56 0
               OpReturn
         %93 = OpLabel
               OpLine %1 58 0
        %102 = OpAccessChain %_ptr_StorageBuffer_ulong %_ %int_0 %int_0 %int_3
        %103 = OpLoad %ulong %102
        %104 = OpConvertUToPtr %_ptr_PhysicalStorageBuffer_TransparentIndirectDraws %103
               OpStore %cmdBuf_0 %104
               OpLine %1 59 0
        %112 = OpAccessChain %_ptr_StorageBuffer_ulong %_ %int_0 %int_0 %int_2
        %113 = OpLoad %ulong %112
        %114 = OpConvertUToPtr %_ptr_PhysicalStorageBuffer_TransparentInstances %113
               OpStore %instBuf_0 %114
               OpLine %1 61 0
        %115 = OpLoad %_ptr_PhysicalStorageBuffer_TransparentIndirectDraws %cmdBuf_0
        %116 = OpLoad %uint %tIndex
        %118 = OpAccessChain %_ptr_PhysicalStorageBuffer_IndirectDrawCmd_1 %115 %int_0 %116
        %119 = OpLoad %IndirectDrawCmd_1 %118 Aligned 4
        %120 = OpCopyLogical %IndirectDrawCmd_0 %119
               OpStore %drawCmd %120
               OpLine %1 62 0
        %121 = OpAccessChain %_ptr_Function_uint %drawCmd %int_4
        %122 = OpLoad %uint %121
        %123 = OpLoad %int %gl_InstanceIndex
        %124 = OpBitcast %uint %123
        %125 = OpIAdd %uint %122 %124
               OpStore %vInstanceID %125
               OpLine %1 63 0
        %126 = OpLoad %_ptr_PhysicalStorageBuffer_TransparentInstances %instBuf_0
        %127 = OpLoad %uint %vInstanceID
        %129 = OpAccessChain %_ptr_PhysicalStorageBuffer_Instance_1 %126 %int_0 %127
        %130 = OpLoad %Instance_1 %129 Aligned 16
        %131 = OpCopyLogical %Instance_0 %130
               OpStore %inst %131
               OpBranch %27
         %27 = OpLabel
               OpLine %1 66 0
        %134 = OpLoad %int %gl_VertexIndex
        %135 = OpBitcast %uint %134
               OpStore %vertIdx %135
               OpLine %1 67 0
        %136 = OpLoad %uint %vertIdx
        %137 = OpAccessChain %_ptr_PushConstant_uint %drawData %int_2
        %138 = OpLoad %uint %137
        %139 = OpUGreaterThanEqual %bool %136 %138
               OpSelectionMerge %141 None
               OpBranchConditional %139 %140 %141
        %140 = OpLabel
               OpLine %1 67 0
               OpReturn
        %141 = OpLabel
               OpLine %1 70 0
        %157 = OpAccessChain %_ptr_StorageBuffer_ulong %__0 %int_0 %int_0 %int_7
        %158 = OpLoad %ulong %157
        %159 = OpConvertUToPtr %_ptr_PhysicalStorageBuffer_VertexBuffer %158
               OpStore %vertexBuf %159
               OpLine %1 71 0
        %163 = OpLoad %_ptr_PhysicalStorageBuffer_VertexBuffer %vertexBuf
        %164 = OpLoad %uint %vertIdx
        %166 = OpAccessChain %_ptr_PhysicalStorageBuffer_Vertex %163 %int_0 %164
        %167 = OpLoad %Vertex %166 Aligned 16
        %168 = OpCopyLogical %Vertex_0 %167
               OpStore %vtx %168
               OpLine %1 74 0
        %176 = OpAccessChain %_ptr_StorageBuffer_ulong %_ %int_0 %int_0 %int_9
        %177 = OpLoad %ulong %176
        %178 = OpConvertUToPtr %_ptr_PhysicalStorageBuffer_TransformsListBuffer %177
               OpStore %transformsBuffer %178
               OpLine %1 75 0
        %181 = OpLoad %_ptr_PhysicalStorageBuffer_TransformsListBuffer %transformsBuffer
        %182 = OpAccessChain %_ptr_Function_uint %inst %int_3
        %183 = OpLoad %uint %182
        %185 = OpAccessChain %_ptr_PhysicalStorageBuffer_mat4v4float %181 %int_0 %183
        %186 = OpLoad %mat4v4float %185 Aligned 16
               OpStore %model %186
               OpLine %1 77 0
        %189 = OpLoad %mat4v4float %model
        %191 = OpAccessChain %_ptr_Function_v3float %vtx %int_0
        %192 = OpLoad %v3float %191
        %194 = OpCompositeExtract %float %192 0
        %195 = OpCompositeExtract %float %192 1
        %196 = OpCompositeExtract %float %192 2
        %197 = OpCompositeConstruct %v4float %194 %195 %196 %float_1
        %198 = OpMatrixTimesVector %v4float %189 %197
               OpStore %worldPos4 %198
               OpLine %1 78 0
        %201 = OpLoad %v4float %worldPos4
        %202 = OpVectorShuffle %v3float %201 %201 0 1 2
               OpStore %outWorldPos %202
               OpLine %1 79 0
        %213 = OpAccessChain %_ptr_Uniform_mat4v4float %__2 %int_0 %int_2
        %214 = OpLoad %mat4v4float %213
        %215 = OpLoad %v4float %worldPos4
        %216 = OpMatrixTimesVector %v4float %214 %215
        %218 = OpAccessChain %_ptr_Output_v4float %__1 %int_0
               OpStore %218 %216
               OpLine %1 81 0
        %222 = OpLoad %mat4v4float %model
        %223 = OpCompositeExtract %v4float %222 0
        %224 = OpVectorShuffle %v3float %223 %223 0 1 2
        %225 = OpCompositeExtract %v4float %222 1
        %226 = OpVectorShuffle %v3float %225 %225 0 1 2
        %227 = OpCompositeExtract %v4float %222 2
        %228 = OpVectorShuffle %v3float %227 %227 0 1 2
        %229 = OpCompositeConstruct %mat3v3float %224 %226 %228
        %230 = OpExtInst %mat3v3float %3 MatrixInverse %229
        %231 = OpTranspose %mat3v3float %230
               OpStore %normalMatrix %231
               OpLine %1 82 0
        %233 = OpLoad %mat3v3float %normalMatrix
        %234 = OpAccessChain %_ptr_Function_v3float %vtx %int_1
        %235 = OpLoad %v3float %234
        %236 = OpMatrixTimesVector %v3float %233 %235
        %237 = OpExtInst %v3float %3 Normalize %236
               OpStore %outNormal %237
               OpLine %1 83 0
        %239 = OpAccessChain %_ptr_Function_v4float %vtx %int_3
        %240 = OpLoad %v4float %239
        %241 = OpVectorShuffle %v3float %240 %240 0 1 2
               OpStore %outColor %241
               OpLine %1 84 0
        %245 = OpAccessChain %_ptr_Function_v2float %vtx %int_2
        %246 = OpLoad %v2float %245
               OpStore %outUV %246
               OpLine %1 85 0
               OpReturn
               OpFunctionEnd
