; SPIR-V
; Version: 1.6
; Generator: Khronos Glslang Reference Front End; 11
; Bound: 710
; Schema: 0
               OpCapability Shader
               OpCapability Int64
               OpCapability ShaderNonUniform
               OpCapability RuntimeDescriptorArray
               OpCapability SampledImageArrayNonUniformIndexing
               OpCapability PhysicalStorageBufferAddresses
               OpCapability DemoteToHelperInvocation
          %4 = OpExtInstImport "GLSL.std.450"
               OpMemoryModel PhysicalStorageBuffer64 GLSL450
               OpEntryPoint Fragment %main "main" %envMaps %combinedSamplers %vDrawID %drawData %_ %vInstanceID %__0 %__1 %inUV %inNormal %__2 %inColor %inWorldPos %outFragColor
               OpExecutionMode %main OriginUpperLeft
          %1 = OpString "C:\\Users\\Justi\\source\\repos\\VulkanRenderer\\VulkanRenderer\\res\\shaders\\meshes\\mesh_frag.frag"
          %2 = OpString "C:/Users/Justi/source/repos/VulkanRenderer/VulkanRenderer/res/shaders/meshes/../include/gpu_scene_structures.glsl"
          %3 = OpString "C:/Users/Justi/source/repos/VulkanRenderer/VulkanRenderer/res/shaders/meshes/../include/pbr.glsl"
               OpSource GLSL 450 %1 "#version 450

#extension GL_ARB_shader_draw_parameters : require
#extension GL_EXT_buffer_reference : require
#extension GL_EXT_scalar_block_layout : require
#extension GL_ARB_gpu_shader_int64 : require
#extension GL_GOOGLE_include_directive : require
#extension GL_ARB_separate_shader_objects : require
#extension GL_EXT_nonuniform_qualifier : require

#include \"../include/gpu_scene_structures.glsl\"
#include \"../include/pbr.glsl\"

layout(location = 0) in vec3 inNormal;
layout(location = 1) in vec3 inColor;
layout(location = 2) in vec2 inUV;
layout(location = 3) in vec3 inWorldPos;
layout(location = 4) flat in uint vDrawID;
layout(location = 5) flat in uint vInstanceID;

layout(location = 0) out vec4 outFragColor;

layout(set = 0, binding = 0, scalar) readonly buffer GlobalAddressTableBuffer {
    GPUAddressTable globalAddressTable;
};

layout(set = 0, binding = 1) uniform EnvMapData {
    EnvMapBindingSet envMapSet;
};

layout(set = 0, binding = 2) uniform samplerCube envMaps[];
layout(set = 0, binding = 4) uniform sampler2D combinedSamplers[];


layout(set = 1, binding = 0, scalar) readonly buffer FrameAddressTableBuffer {
    GPUAddressTable frameAddressTable;
};

layout(set = 1, binding = 1) uniform SceneUBO {
    SceneData scene;
};

layout(push_constant) uniform DrawPushConstants {
	uint opaqueDrawCount;
	uint transparentDrawCount;
	uint totalVertexCount;
	uint totalIndexCount;
} drawData;

const float PI = 3.14159265359;
const float MAX_REFLECTION_LOD = 4.0;
const uint DIFF_IRRA_MIP_LEVEL = 2;
const bool FLIP_ENVIRONMENT_MAP_Y = true;
const float MAX_AO_SATURATION = 10.0;

vec3 DiffuseIrradiance(vec3 N, uint diffuseIdx) {
	vec3 ENV_N = N;
	if (FLIP_ENVIRONMENT_MAP_Y) ENV_N.y = -ENV_N.y;
	return textureLod(envMaps[nonuniformEXT(diffuseIdx)], ENV_N, DIFF_IRRA_MIP_LEVEL).rgb;
}

vec3 SpecularReflection(vec3 V, vec3 N, float roughness, vec3 F, uint specularIdx, uint brdfIdx) {
	vec3 R = reflect(-V, N);
	if (FLIP_ENVIRONMENT_MAP_Y) R.y = -R.y;
	vec3 prefilteredColor = textureLod(envMaps[nonuniformEXT(specularIdx)], R, roughness * MAX_REFLECTION_LOD).rgb;
	vec2 envBRDF = texture(combinedSamplers[nonuniformEXT(brdfIdx)], vec2(max(dot(N, V), 0.0), roughness)).rg;
	return prefilteredColor * (F * envBRDF.x + envBRDF.y);
}

void main() {
	IndirectDrawCmd drawCmd;
	Instance inst;

	if (vDrawID < drawData.opaqueDrawCount) {
		// Opaque draw
		OpaqueIndirectDraws cmdBuf = OpaqueIndirectDraws(frameAddressTable.addrs[ABT_OpaqueIndirectDraws]);
		OpaqueInstances instBuf = OpaqueInstances(frameAddressTable.addrs[ABT_OpaqueInstances]);

		drawCmd = cmdBuf.opaqueIndirect[vDrawID];
		inst = instBuf.opaqueInstances[vInstanceID];
	} else {
		// Transparent draw
		uint tIndex = vDrawID - drawData.opaqueDrawCount;
		if (tIndex >= drawData.transparentDrawCount) return;

		TransparentIndirectDraws cmdBuf = TransparentIndirectDraws(frameAddressTable.addrs[ABT_TransparentIndirectDraws]);
		TransparentInstances instBuf = TransparentInstances(frameAddressTable.addrs[ABT_TransparentInstances]);

		drawCmd = cmdBuf.transparentIndirect[tIndex];
		inst = instBuf.transparentInstances[vInstanceID];
	}

	Material mat = MaterialBuffer(globalAddressTable.addrs[ABT_Material]).materials[inst.materialID];

	// Environment image indices for IBL
	uint diffuseIdx = uint(envMapSet.mapIndices[0].x);
	uint specularIdx = uint(envMapSet.mapIndices[0].y);
	uint brdfIdx = uint(envMapSet.mapIndices[0].z);

	vec4 albedoMap = texture(combinedSamplers[nonuniformEXT(mat.albedoLUTIndex)], inUV) * mat.colorFactor;
	vec4 mrSample  = texture(combinedSamplers[nonuniformEXT(mat.metalRoughLUTIndex)], inUV);
	vec3 normalMap = texture(combinedSamplers[nonuniformEXT(mat.normalLUTIndex)], inUV).rgb;
	float ao       = texture(combinedSamplers[nonuniformEXT(mat.aoLUTIndex)], inUV).r * mat.ambientOcclusion;

	vec3 emissive = mat.emissiveColor * mat.emissiveStrength;

	if (albedoMap.w < mat.alphaCutoff) discard;

	vec3 sampledNormal = normalize(normalMap * 2.0 - 1.0);
	vec3 normal = normalize(mix(inNormal, sampledNormal, mat.normalScale));

	vec3 lightColor = scene.sunlightColor.rgb * scene.sunlightColor.a;
	vec3 albedo = inColor * albedoMap.rgb;
	vec3 viewDir = normalize(scene.cameraPos.xyz - inWorldPos);
	vec3 lightDir = normalize(scene.sunlightDirection.xyz);
	vec3 H = normalize(viewDir + lightDir);

	float roughness = clamp(mrSample.g * mat.metalRoughFactors.y, 0.05, 1.0);
	float metallic = mrSample.b * mat.metalRoughFactors.x;

	float NDF = D_GGX(normal, H, roughness);
	float G = G_SCHLICKGGX_SMITH(normal, viewDir, lightDir, roughness);
	vec3 F0 = mix(vec3(0.04), albedo, metallic);
	vec3 F = F_SCHLICK(viewDir, H, F0);

	vec3 numerator = NDF * G * F;
	float denominator = 4.0 * max(dot(normal, viewDir), 0.0) * max(dot(normal, lightDir), 0.0);
	vec3 specular = numerator / max(denominator, 0.001);

	vec3 kS = F;
	vec3 kD = vec3(1.0) - kS;
	kD *= 1.0 - metallic;

	float NdotL = max(dot(normal, lightDir), 0.0);
	vec3 diffuse = Lambert(kD, albedo);

	vec3 irradiance = DiffuseIrradiance(normal, diffuseIdx);
	vec3 reflectionDiffuse = irradiance * albedo;
	vec3 reflectionSpecular = SpecularReflection(viewDir, normal, roughness, F, specularIdx, brdfIdx);

	vec3 ambient = kD * (reflectionDiffuse + reflectionSpecular);
	float sat_factor = mix(MAX_AO_SATURATION, 1, ao);
	albedo = pow(albedo, vec3(sat_factor));

	vec3 finalColor = (diffuse + specular) * lightColor * NdotL;
	vec3 correctedAmbient = ambient / (ambient + vec3(1.0));
	correctedAmbient = pow(correctedAmbient, vec3(1.0 / 2.2));
	finalColor += correctedAmbient + emissive;
	finalColor += vec3(0.5) * ao;

	//outFragColor = vec4(finalColor, albedoMap.w);

	//outFragColor = vec4(reflectionSpecular, albedoMap.w);
	//outFragColor = vec4(reflectionDiffuse, albedoMap.w);
	//outFragColor = vec4(irradiance, albedoMap.w);
	//outFragColor = vec4(diffuse, 1.0);
	//outFragColor = vec4(vec3(metallic), 1.0);
	//outFragColor = vec4(vec3(roughness), 1.0);
	outFragColor = vec4(albedo, albedoMap.w);
	//outFragColor = vec4(normalize(reflect(-viewDir, normal)) * 0.5 + 0.5, 1.0);
	//outFragColor = vec4(sampledNormal, 1.0);
	//outFragColor = vec4(inUV, 0.0, 1.0);
	//outFragColor = vec4(inColor, 1.0);
	//outFragColor = vec4(emissive, 1.0);
}"
               OpSource GLSL 450 %2 "#extension GL_EXT_buffer_reference : require
#extension GL_EXT_scalar_block_layout : require
#extension GL_ARB_gpu_shader_int64 : require

#ifndef GPU_SCENE_STRUCTURES_GLSL
#define GPU_SCENE_STRUCTURES_GLSL

struct SceneData {
    mat4 view;
    mat4 proj;
    mat4 viewproj;
    vec4 ambientColor;
    vec4 sunlightDirection; // .w = power
    vec4 sunlightColor;
    vec4 cameraPos;
};

// Number of env sets stored in the buffer (must match C++ side)
const uint MAX_ENV_SETS = 16u;

struct EnvMapBindingSet {
    vec4 mapIndices[MAX_ENV_SETS];
    // x = diffuseMapIndex
    // y = specularMapIndex
    // z = brdfLUTIndex
    // w = skyboxMapIndex
};

struct AABB {
	vec3 vmin; // origin: 0.5f * (vmin + vmax)
	vec3 vmax; // extent: 0.5f * (vmax - vmin)
	vec3 origin;
	vec3 extent;
	float sphereRadius;
};

struct Vertex {
    vec3 position;
    vec3 normal;
    vec2 uv;
    vec4 color;
};


struct Material {
    vec4 colorFactor;
    vec2 metalRoughFactors;

    uint albedoLUTIndex;
    uint metalRoughLUTIndex;
    uint normalLUTIndex;
    uint aoLUTIndex;

    vec3 emissiveColor;
    float emissiveStrength;

    float ambientOcclusion;
    float normalScale;
    float alphaCutoff;
    uint passType;
};

struct Mesh {
    AABB localAABB;
    AABB worldAABB;
    uint drawRangeID;
};


struct Instance {
    uint instanceID;
    uint materialID;
    uint meshID;
    uint transformID;
};

// Enum address buffer types
const uint ABT_OpaqueInstances          = 0u; // frame
const uint ABT_OpaqueIndirectDraws      = 1u; // frame
const uint ABT_TransparentInstances     = 2u; // frame
const uint ABT_TransparentIndirectDraws = 3u; // frame
const uint ABT_Material                 = 4u; // global
const uint ABT_Mesh                     = 5u; // global
const uint ABT_DrawRange                = 6u; // global
const uint ABT_Vertex                   = 7u; // global
const uint ABT_Index                    = 8u; // global
const uint ABT_Transforms               = 9u; // frame
const uint ABT_VisibleCount             = 10u; // frame
const uint ABT_VisibleMeshIDs           = 11u; // frame
const uint ABT_Count                    = 12u;

struct GPUAddressTable {
    uint64_t addrs[ABT_Count];
};

struct GPUDrawRange {
    uint firstIndex;
    uint indexCount;
    uint vertexOffset;
    uint vertexCount;
};

struct IndirectDrawCmd {
    uint indexCount;
    uint instanceCount;
    uint firstIndex;
    int vertexOffset;
    uint firstInstance;
};

// GPU-only buffers

// Opaque and transparent data is a render time upload
// Only visible data makes it through

// Opaque
layout(buffer_reference, scalar) readonly buffer OpaqueInstances {
    Instance opaqueInstances[];
};
layout(buffer_reference, scalar) readonly buffer OpaqueIndirectDraws {
    IndirectDrawCmd opaqueIndirect[];
};

// Transparent
layout(buffer_reference, scalar) readonly buffer TransparentInstances {
    Instance transparentInstances[];
};
layout(buffer_reference, scalar) readonly buffer TransparentIndirectDraws {
    IndirectDrawCmd transparentIndirect[];
};

// ranges, materials, vertices, indices, all ready at render time and uploaded at end of asset loading
layout(buffer_reference, scalar) readonly buffer DrawRangeBuffer {
    GPUDrawRange ranges[];
};

layout(buffer_reference, scalar) readonly buffer MaterialBuffer {
    Material materials[];
};

layout(buffer_reference, scalar) readonly buffer VertexBuffer {
    Vertex vertices[];
};

layout(buffer_reference, scalar) readonly buffer IndexBuffer {
    uint indices[];
};

layout(buffer_reference, scalar) readonly buffer TransformsListBuffer {
    mat4 transforms[];
};

// In current cpu based setup, worldAABBs are done on cpu after main upload,
// all thats present here currently is localAABB and drawRangeIndex
layout(buffer_reference, scalar) readonly buffer MeshBuffer {
    Mesh meshes[];
};


// Inactives
layout(buffer_reference, scalar) writeonly buffer VisibleCountBuffer {
    uint visibleCount;
};

layout(buffer_reference, scalar) writeonly buffer VisibleMeshIDBuffer {
    uint visibleMeshIDs[];
};

#endif"
               OpSource GLSL 450 %3 "#ifndef PBR_GLSL
#define PBR_GLSL

vec3 Lambert(vec3 kD, vec3 albedo)
{
    return kD * albedo / 3.14159265359;
}

float D_GGX(vec3 N, vec3 H, float roughness){
    // Brian Karis says GGX NDF has a longer \"tail\" that appears more natural
    float a = roughness * roughness;
    float a2 = a * a; // disney reparameterization
    float NdotH = max(dot(N, H), 0.0f);
    float NdotH2 = NdotH * NdotH;

    float num = a2;
    float premult = NdotH2 * (a2 - 1.0f) + 1.0f;
    float denom = 3.14159265359 * premult * premult;
    return num / denom;
}

float G_SCHLICKGGX(float NdotX, float k){
    float num = NdotX;
    float denom = NdotX * (1.0f - k) + k;
    return num / denom;
}


float G_SCHLICKGGX_SMITH(vec3 N, vec3 V, vec3 L, float roughness){
    // height correlated smith method

    // \"Disney reduced hotness\" - Brian Karis
    float r = (roughness + 1);
    float k = (r * r) / 8.0f;

    float NDotV = max(dot(N, V), 0.0f);
    float NDotL = max(dot(N, L), 0.0f);

    float ggx2 = G_SCHLICKGGX(NDotV, k);
    float ggx1 = G_SCHLICKGGX(NDotL, k);
    return ggx1 * ggx2;
}

float FRESNEL_POWER_UNREAL(vec3 V, vec3 H){
    float VDotH = dot(V, H);
    return (-5.55473 * VDotH - 6.98316) * VDotH;

}

vec3 F_SCHLICK(vec3 V, vec3 H, vec3 F0){
    float VdotH = max(dot(V, H), 0.0f);

    // classic
    //return F0 + (1.0f - F0) * pow(1.0f - VdotH, 5.0f);

    // unreal optimized
    return F0 + (1 - F0) * pow(2, FRESNEL_POWER_UNREAL(V, H));
}

#endif"
               OpSourceExtension "GL_ARB_gpu_shader_int64"
               OpSourceExtension "GL_ARB_separate_shader_objects"
               OpSourceExtension "GL_ARB_shader_draw_parameters"
               OpSourceExtension "GL_EXT_buffer_reference"
               OpSourceExtension "GL_EXT_nonuniform_qualifier"
               OpSourceExtension "GL_EXT_scalar_block_layout"
               OpSourceExtension "GL_GOOGLE_cpp_style_line_directive"
               OpSourceExtension "GL_GOOGLE_include_directive"
               OpName %main "main"
               OpName %Lambert_vf3_vf3_ "Lambert(vf3;vf3;"
               OpName %kD "kD"
               OpName %albedo "albedo"
               OpName %D_GGX_vf3_vf3_f1_ "D_GGX(vf3;vf3;f1;"
               OpName %N "N"
               OpName %H "H"
               OpName %roughness "roughness"
               OpName %G_SCHLICKGGX_f1_f1_ "G_SCHLICKGGX(f1;f1;"
               OpName %NdotX "NdotX"
               OpName %k "k"
               OpName %G_SCHLICKGGX_SMITH_vf3_vf3_vf3_f1_ "G_SCHLICKGGX_SMITH(vf3;vf3;vf3;f1;"
               OpName %N_0 "N"
               OpName %V "V"
               OpName %L "L"
               OpName %roughness_0 "roughness"
               OpName %FRESNEL_POWER_UNREAL_vf3_vf3_ "FRESNEL_POWER_UNREAL(vf3;vf3;"
               OpName %V_0 "V"
               OpName %H_0 "H"
               OpName %F_SCHLICK_vf3_vf3_vf3_ "F_SCHLICK(vf3;vf3;vf3;"
               OpName %V_1 "V"
               OpName %H_1 "H"
               OpName %F0 "F0"
               OpName %DiffuseIrradiance_vf3_u1_ "DiffuseIrradiance(vf3;u1;"
               OpName %N_1 "N"
               OpName %diffuseIdx "diffuseIdx"
               OpName %SpecularReflection_vf3_vf3_f1_vf3_u1_u1_ "SpecularReflection(vf3;vf3;f1;vf3;u1;u1;"
               OpName %V_2 "V"
               OpName %N_2 "N"
               OpName %roughness_1 "roughness"
               OpName %F "F"
               OpName %specularIdx "specularIdx"
               OpName %brdfIdx "brdfIdx"
               OpName %a "a"
               OpName %a2 "a2"
               OpName %NdotH "NdotH"
               OpName %NdotH2 "NdotH2"
               OpName %num "num"
               OpName %premult "premult"
               OpName %denom "denom"
               OpName %num_0 "num"
               OpName %denom_0 "denom"
               OpName %r "r"
               OpName %k_0 "k"
               OpName %NDotV "NDotV"
               OpName %NDotL "NDotL"
               OpName %ggx2 "ggx2"
               OpName %param "param"
               OpName %param_0 "param"
               OpName %ggx1 "ggx1"
               OpName %param_1 "param"
               OpName %param_2 "param"
               OpName %VDotH "VDotH"
               OpName %VdotH "VdotH"
               OpName %param_3 "param"
               OpName %param_4 "param"
               OpName %ENV_N "ENV_N"
               OpName %envMaps "envMaps"
               OpName %R "R"
               OpName %prefilteredColor "prefilteredColor"
               OpName %envBRDF "envBRDF"
               OpName %combinedSamplers "combinedSamplers"
               OpName %vDrawID "vDrawID"
               OpName %DrawPushConstants "DrawPushConstants"
               OpMemberName %DrawPushConstants 0 "opaqueDrawCount"
               OpMemberName %DrawPushConstants 1 "transparentDrawCount"
               OpMemberName %DrawPushConstants 2 "totalVertexCount"
               OpMemberName %DrawPushConstants 3 "totalIndexCount"
               OpName %drawData "drawData"
               OpName %IndirectDrawCmd "IndirectDrawCmd"
               OpMemberName %IndirectDrawCmd 0 "indexCount"
               OpMemberName %IndirectDrawCmd 1 "instanceCount"
               OpMemberName %IndirectDrawCmd 2 "firstIndex"
               OpMemberName %IndirectDrawCmd 3 "vertexOffset"
               OpMemberName %IndirectDrawCmd 4 "firstInstance"
               OpName %OpaqueIndirectDraws "OpaqueIndirectDraws"
               OpMemberName %OpaqueIndirectDraws 0 "opaqueIndirect"
               OpName %cmdBuf "cmdBuf"
               OpName %GPUAddressTable "GPUAddressTable"
               OpMemberName %GPUAddressTable 0 "addrs"
               OpName %FrameAddressTableBuffer "FrameAddressTableBuffer"
               OpMemberName %FrameAddressTableBuffer 0 "frameAddressTable"
               OpName %_ ""
               OpName %Instance "Instance"
               OpMemberName %Instance 0 "instanceID"
               OpMemberName %Instance 1 "materialID"
               OpMemberName %Instance 2 "meshID"
               OpMemberName %Instance 3 "transformID"
               OpName %OpaqueInstances "OpaqueInstances"
               OpMemberName %OpaqueInstances 0 "opaqueInstances"
               OpName %instBuf "instBuf"
               OpName %IndirectDrawCmd_0 "IndirectDrawCmd"
               OpMemberName %IndirectDrawCmd_0 0 "indexCount"
               OpMemberName %IndirectDrawCmd_0 1 "instanceCount"
               OpMemberName %IndirectDrawCmd_0 2 "firstIndex"
               OpMemberName %IndirectDrawCmd_0 3 "vertexOffset"
               OpMemberName %IndirectDrawCmd_0 4 "firstInstance"
               OpName %drawCmd "drawCmd"
               OpName %Instance_0 "Instance"
               OpMemberName %Instance_0 0 "instanceID"
               OpMemberName %Instance_0 1 "materialID"
               OpMemberName %Instance_0 2 "meshID"
               OpMemberName %Instance_0 3 "transformID"
               OpName %inst "inst"
               OpName %vInstanceID "vInstanceID"
               OpName %tIndex "tIndex"
               OpName %IndirectDrawCmd_1 "IndirectDrawCmd"
               OpMemberName %IndirectDrawCmd_1 0 "indexCount"
               OpMemberName %IndirectDrawCmd_1 1 "instanceCount"
               OpMemberName %IndirectDrawCmd_1 2 "firstIndex"
               OpMemberName %IndirectDrawCmd_1 3 "vertexOffset"
               OpMemberName %IndirectDrawCmd_1 4 "firstInstance"
               OpName %TransparentIndirectDraws "TransparentIndirectDraws"
               OpMemberName %TransparentIndirectDraws 0 "transparentIndirect"
               OpName %cmdBuf_0 "cmdBuf"
               OpName %Instance_1 "Instance"
               OpMemberName %Instance_1 0 "instanceID"
               OpMemberName %Instance_1 1 "materialID"
               OpMemberName %Instance_1 2 "meshID"
               OpMemberName %Instance_1 3 "transformID"
               OpName %TransparentInstances "TransparentInstances"
               OpMemberName %TransparentInstances 0 "transparentInstances"
               OpName %instBuf_0 "instBuf"
               OpName %Material "Material"
               OpMemberName %Material 0 "colorFactor"
               OpMemberName %Material 1 "metalRoughFactors"
               OpMemberName %Material 2 "albedoLUTIndex"
               OpMemberName %Material 3 "metalRoughLUTIndex"
               OpMemberName %Material 4 "normalLUTIndex"
               OpMemberName %Material 5 "aoLUTIndex"
               OpMemberName %Material 6 "emissiveColor"
               OpMemberName %Material 7 "emissiveStrength"
               OpMemberName %Material 8 "ambientOcclusion"
               OpMemberName %Material 9 "normalScale"
               OpMemberName %Material 10 "alphaCutoff"
               OpMemberName %Material 11 "passType"
               OpName %mat "mat"
               OpName %GlobalAddressTableBuffer "GlobalAddressTableBuffer"
               OpMemberName %GlobalAddressTableBuffer 0 "globalAddressTable"
               OpName %__0 ""
               OpName %Material_0 "Material"
               OpMemberName %Material_0 0 "colorFactor"
               OpMemberName %Material_0 1 "metalRoughFactors"
               OpMemberName %Material_0 2 "albedoLUTIndex"
               OpMemberName %Material_0 3 "metalRoughLUTIndex"
               OpMemberName %Material_0 4 "normalLUTIndex"
               OpMemberName %Material_0 5 "aoLUTIndex"
               OpMemberName %Material_0 6 "emissiveColor"
               OpMemberName %Material_0 7 "emissiveStrength"
               OpMemberName %Material_0 8 "ambientOcclusion"
               OpMemberName %Material_0 9 "normalScale"
               OpMemberName %Material_0 10 "alphaCutoff"
               OpMemberName %Material_0 11 "passType"
               OpName %MaterialBuffer "MaterialBuffer"
               OpMemberName %MaterialBuffer 0 "materials"
               OpName %diffuseIdx_0 "diffuseIdx"
               OpName %EnvMapBindingSet "EnvMapBindingSet"
               OpMemberName %EnvMapBindingSet 0 "mapIndices"
               OpName %EnvMapData "EnvMapData"
               OpMemberName %EnvMapData 0 "envMapSet"
               OpName %__1 ""
               OpName %specularIdx_0 "specularIdx"
               OpName %brdfIdx_0 "brdfIdx"
               OpName %albedoMap "albedoMap"
               OpName %inUV "inUV"
               OpName %mrSample "mrSample"
               OpName %normalMap "normalMap"
               OpName %ao "ao"
               OpName %emissive "emissive"
               OpName %sampledNormal "sampledNormal"
               OpName %normal "normal"
               OpName %inNormal "inNormal"
               OpName %lightColor "lightColor"
               OpName %SceneData "SceneData"
               OpMemberName %SceneData 0 "view"
               OpMemberName %SceneData 1 "proj"
               OpMemberName %SceneData 2 "viewproj"
               OpMemberName %SceneData 3 "ambientColor"
               OpMemberName %SceneData 4 "sunlightDirection"
               OpMemberName %SceneData 5 "sunlightColor"
               OpMemberName %SceneData 6 "cameraPos"
               OpName %SceneUBO "SceneUBO"
               OpMemberName %SceneUBO 0 "scene"
               OpName %__2 ""
               OpName %albedo_0 "albedo"
               OpName %inColor "inColor"
               OpName %viewDir "viewDir"
               OpName %inWorldPos "inWorldPos"
               OpName %lightDir "lightDir"
               OpName %H_2 "H"
               OpName %roughness_2 "roughness"
               OpName %metallic "metallic"
               OpName %NDF "NDF"
               OpName %param_5 "param"
               OpName %param_6 "param"
               OpName %param_7 "param"
               OpName %G "G"
               OpName %param_8 "param"
               OpName %param_9 "param"
               OpName %param_10 "param"
               OpName %param_11 "param"
               OpName %F0_0 "F0"
               OpName %F_0 "F"
               OpName %param_12 "param"
               OpName %param_13 "param"
               OpName %param_14 "param"
               OpName %numerator "numerator"
               OpName %denominator "denominator"
               OpName %specular "specular"
               OpName %kS "kS"
               OpName %kD_0 "kD"
               OpName %NdotL "NdotL"
               OpName %diffuse "diffuse"
               OpName %param_15 "param"
               OpName %param_16 "param"
               OpName %irradiance "irradiance"
               OpName %param_17 "param"
               OpName %param_18 "param"
               OpName %reflectionDiffuse "reflectionDiffuse"
               OpName %reflectionSpecular "reflectionSpecular"
               OpName %param_19 "param"
               OpName %param_20 "param"
               OpName %param_21 "param"
               OpName %param_22 "param"
               OpName %param_23 "param"
               OpName %param_24 "param"
               OpName %ambient "ambient"
               OpName %sat_factor "sat_factor"
               OpName %finalColor "finalColor"
               OpName %correctedAmbient "correctedAmbient"
               OpName %outFragColor "outFragColor"
               OpModuleProcessed "client vulkan100"
               OpModuleProcessed "target-env spirv1.6"
               OpModuleProcessed "target-env vulkan1.4"
               OpModuleProcessed "entry-point main"
               OpDecorate %envMaps Binding 2
               OpDecorate %envMaps DescriptorSet 0
               OpDecorate %208 NonUniform
               OpDecorate %210 NonUniform
               OpDecorate %211 NonUniform
               OpDecorate %231 NonUniform
               OpDecorate %232 NonUniform
               OpDecorate %233 NonUniform
               OpDecorate %combinedSamplers Binding 4
               OpDecorate %combinedSamplers DescriptorSet 0
               OpDecorate %249 NonUniform
               OpDecorate %251 NonUniform
               OpDecorate %252 NonUniform
               OpDecorate %vDrawID Flat
               OpDecorate %vDrawID Location 4
               OpDecorate %DrawPushConstants Block
               OpMemberDecorate %DrawPushConstants 0 Offset 0
               OpMemberDecorate %DrawPushConstants 1 Offset 4
               OpMemberDecorate %DrawPushConstants 2 Offset 8
               OpMemberDecorate %DrawPushConstants 3 Offset 12
               OpMemberDecorate %IndirectDrawCmd 0 Offset 0
               OpMemberDecorate %IndirectDrawCmd 1 Offset 4
               OpMemberDecorate %IndirectDrawCmd 2 Offset 8
               OpMemberDecorate %IndirectDrawCmd 3 Offset 12
               OpMemberDecorate %IndirectDrawCmd 4 Offset 16
               OpDecorate %_runtimearr_IndirectDrawCmd ArrayStride 20
               OpDecorate %OpaqueIndirectDraws Block
               OpMemberDecorate %OpaqueIndirectDraws 0 NonWritable
               OpMemberDecorate %OpaqueIndirectDraws 0 Offset 0
               OpDecorate %cmdBuf AliasedPointer
               OpDecorate %_arr_ulong_uint_12 ArrayStride 8
               OpMemberDecorate %GPUAddressTable 0 Offset 0
               OpDecorate %FrameAddressTableBuffer Block
               OpMemberDecorate %FrameAddressTableBuffer 0 NonWritable
               OpMemberDecorate %FrameAddressTableBuffer 0 Offset 0
               OpDecorate %_ NonWritable
               OpDecorate %_ Binding 0
               OpDecorate %_ DescriptorSet 1
               OpMemberDecorate %Instance 0 Offset 0
               OpMemberDecorate %Instance 1 Offset 4
               OpMemberDecorate %Instance 2 Offset 8
               OpMemberDecorate %Instance 3 Offset 12
               OpDecorate %_runtimearr_Instance ArrayStride 16
               OpDecorate %OpaqueInstances Block
               OpMemberDecorate %OpaqueInstances 0 NonWritable
               OpMemberDecorate %OpaqueInstances 0 Offset 0
               OpDecorate %instBuf AliasedPointer
               OpDecorate %vInstanceID Flat
               OpDecorate %vInstanceID Location 5
               OpMemberDecorate %IndirectDrawCmd_1 0 Offset 0
               OpMemberDecorate %IndirectDrawCmd_1 1 Offset 4
               OpMemberDecorate %IndirectDrawCmd_1 2 Offset 8
               OpMemberDecorate %IndirectDrawCmd_1 3 Offset 12
               OpMemberDecorate %IndirectDrawCmd_1 4 Offset 16
               OpDecorate %_runtimearr_IndirectDrawCmd_1 ArrayStride 20
               OpDecorate %TransparentIndirectDraws Block
               OpMemberDecorate %TransparentIndirectDraws 0 NonWritable
               OpMemberDecorate %TransparentIndirectDraws 0 Offset 0
               OpDecorate %cmdBuf_0 AliasedPointer
               OpMemberDecorate %Instance_1 0 Offset 0
               OpMemberDecorate %Instance_1 1 Offset 4
               OpMemberDecorate %Instance_1 2 Offset 8
               OpMemberDecorate %Instance_1 3 Offset 12
               OpDecorate %_runtimearr_Instance_1 ArrayStride 16
               OpDecorate %TransparentInstances Block
               OpMemberDecorate %TransparentInstances 0 NonWritable
               OpMemberDecorate %TransparentInstances 0 Offset 0
               OpDecorate %instBuf_0 AliasedPointer
               OpDecorate %GlobalAddressTableBuffer Block
               OpMemberDecorate %GlobalAddressTableBuffer 0 NonWritable
               OpMemberDecorate %GlobalAddressTableBuffer 0 Offset 0
               OpDecorate %__0 NonWritable
               OpDecorate %__0 Binding 0
               OpDecorate %__0 DescriptorSet 0
               OpMemberDecorate %Material_0 0 Offset 0
               OpMemberDecorate %Material_0 1 Offset 16
               OpMemberDecorate %Material_0 2 Offset 24
               OpMemberDecorate %Material_0 3 Offset 28
               OpMemberDecorate %Material_0 4 Offset 32
               OpMemberDecorate %Material_0 5 Offset 36
               OpMemberDecorate %Material_0 6 Offset 40
               OpMemberDecorate %Material_0 7 Offset 52
               OpMemberDecorate %Material_0 8 Offset 56
               OpMemberDecorate %Material_0 9 Offset 60
               OpMemberDecorate %Material_0 10 Offset 64
               OpMemberDecorate %Material_0 11 Offset 68
               OpDecorate %_runtimearr_Material_0 ArrayStride 72
               OpDecorate %MaterialBuffer Block
               OpMemberDecorate %MaterialBuffer 0 NonWritable
               OpMemberDecorate %MaterialBuffer 0 Offset 0
               OpDecorate %_arr_v4float_uint_16 ArrayStride 16
               OpMemberDecorate %EnvMapBindingSet 0 Offset 0
               OpDecorate %EnvMapData Block
               OpMemberDecorate %EnvMapData 0 Offset 0
               OpDecorate %__1 Binding 1
               OpDecorate %__1 DescriptorSet 0
               OpDecorate %423 NonUniform
               OpDecorate %424 NonUniform
               OpDecorate %425 NonUniform
               OpDecorate %inUV Location 2
               OpDecorate %436 NonUniform
               OpDecorate %437 NonUniform
               OpDecorate %438 NonUniform
               OpDecorate %444 NonUniform
               OpDecorate %445 NonUniform
               OpDecorate %446 NonUniform
               OpDecorate %454 NonUniform
               OpDecorate %455 NonUniform
               OpDecorate %456 NonUniform
               OpDecorate %inNormal Location 0
               OpMemberDecorate %SceneData 0 ColMajor
               OpMemberDecorate %SceneData 0 MatrixStride 16
               OpMemberDecorate %SceneData 0 Offset 0
               OpMemberDecorate %SceneData 1 ColMajor
               OpMemberDecorate %SceneData 1 MatrixStride 16
               OpMemberDecorate %SceneData 1 Offset 64
               OpMemberDecorate %SceneData 2 ColMajor
               OpMemberDecorate %SceneData 2 MatrixStride 16
               OpMemberDecorate %SceneData 2 Offset 128
               OpMemberDecorate %SceneData 3 Offset 192
               OpMemberDecorate %SceneData 4 Offset 208
               OpMemberDecorate %SceneData 5 Offset 224
               OpMemberDecorate %SceneData 6 Offset 240
               OpDecorate %SceneUBO Block
               OpMemberDecorate %SceneUBO 0 Offset 0
               OpDecorate %__2 Binding 1
               OpDecorate %__2 DescriptorSet 1
               OpDecorate %inColor Location 1
               OpDecorate %inWorldPos Location 3
               OpDecorate %outFragColor Location 0
       %void = OpTypeVoid
          %6 = OpTypeFunction %void
      %float = OpTypeFloat 32
    %v3float = OpTypeVector %float 3
%_ptr_Function_v3float = OpTypePointer Function %v3float
         %12 = OpTypeFunction %v3float %_ptr_Function_v3float %_ptr_Function_v3float
%_ptr_Function_float = OpTypePointer Function %float
         %18 = OpTypeFunction %float %_ptr_Function_v3float %_ptr_Function_v3float %_ptr_Function_float
         %24 = OpTypeFunction %float %_ptr_Function_float %_ptr_Function_float
         %29 = OpTypeFunction %float %_ptr_Function_v3float %_ptr_Function_v3float %_ptr_Function_v3float %_ptr_Function_float
         %36 = OpTypeFunction %float %_ptr_Function_v3float %_ptr_Function_v3float
         %41 = OpTypeFunction %v3float %_ptr_Function_v3float %_ptr_Function_v3float %_ptr_Function_v3float
       %uint = OpTypeInt 32 0
%_ptr_Function_uint = OpTypePointer Function %uint
         %49 = OpTypeFunction %v3float %_ptr_Function_v3float %_ptr_Function_uint
         %54 = OpTypeFunction %v3float %_ptr_Function_v3float %_ptr_Function_v3float %_ptr_Function_float %_ptr_Function_v3float %_ptr_Function_uint %_ptr_Function_uint
%float_3_14159274 = OpConstant %float 3.14159274
    %float_0 = OpConstant %float 0
    %float_1 = OpConstant %float 1
    %float_8 = OpConstant %float 8
%float_n5_55472994 = OpConstant %float -5.55472994
%float_6_98316002 = OpConstant %float 6.98316002
    %float_2 = OpConstant %float 2
       %bool = OpTypeBool
       %true = OpConstantTrue %bool
     %uint_1 = OpConstant %uint 1
        %202 = OpTypeImage %float Cube 0 0 0 1 Unknown
        %203 = OpTypeSampledImage %202
%_runtimearr_203 = OpTypeRuntimeArray %203
%_ptr_UniformConstant__runtimearr_203 = OpTypePointer UniformConstant %_runtimearr_203
    %envMaps = OpVariable %_ptr_UniformConstant__runtimearr_203 UniformConstant
%_ptr_UniformConstant_203 = OpTypePointer UniformConstant %203
    %v4float = OpTypeVector %float 4
    %float_4 = OpConstant %float 4
    %v2float = OpTypeVector %float 2
%_ptr_Function_v2float = OpTypePointer Function %v2float
        %243 = OpTypeImage %float 2D 0 0 0 1 Unknown
        %244 = OpTypeSampledImage %243
%_runtimearr_244 = OpTypeRuntimeArray %244
%_ptr_UniformConstant__runtimearr_244 = OpTypePointer UniformConstant %_runtimearr_244
%combinedSamplers = OpVariable %_ptr_UniformConstant__runtimearr_244 UniformConstant
%_ptr_UniformConstant_244 = OpTypePointer UniformConstant %244
     %uint_0 = OpConstant %uint 0
%_ptr_Input_uint = OpTypePointer Input %uint
    %vDrawID = OpVariable %_ptr_Input_uint Input
%DrawPushConstants = OpTypeStruct %uint %uint %uint %uint
%_ptr_PushConstant_DrawPushConstants = OpTypePointer PushConstant %DrawPushConstants
   %drawData = OpVariable %_ptr_PushConstant_DrawPushConstants PushConstant
        %int = OpTypeInt 32 1
      %int_0 = OpConstant %int 0
%_ptr_PushConstant_uint = OpTypePointer PushConstant %uint
               OpTypeForwardPointer %_ptr_PhysicalStorageBuffer_OpaqueIndirectDraws PhysicalStorageBuffer
%IndirectDrawCmd = OpTypeStruct %uint %uint %uint %int %uint
%_runtimearr_IndirectDrawCmd = OpTypeRuntimeArray %IndirectDrawCmd
%OpaqueIndirectDraws = OpTypeStruct %_runtimearr_IndirectDrawCmd
%_ptr_PhysicalStorageBuffer_OpaqueIndirectDraws = OpTypePointer PhysicalStorageBuffer %OpaqueIndirectDraws
%_ptr_Function__ptr_PhysicalStorageBuffer_OpaqueIndirectDraws = OpTypePointer Function %_ptr_PhysicalStorageBuffer_OpaqueIndirectDraws
      %ulong = OpTypeInt 64 0
    %uint_12 = OpConstant %uint 12
%_arr_ulong_uint_12 = OpTypeArray %ulong %uint_12
%GPUAddressTable = OpTypeStruct %_arr_ulong_uint_12
%FrameAddressTableBuffer = OpTypeStruct %GPUAddressTable
%_ptr_StorageBuffer_FrameAddressTableBuffer = OpTypePointer StorageBuffer %FrameAddressTableBuffer
          %_ = OpVariable %_ptr_StorageBuffer_FrameAddressTableBuffer StorageBuffer
      %int_1 = OpConstant %int 1
%_ptr_StorageBuffer_ulong = OpTypePointer StorageBuffer %ulong
               OpTypeForwardPointer %_ptr_PhysicalStorageBuffer_OpaqueInstances PhysicalStorageBuffer
   %Instance = OpTypeStruct %uint %uint %uint %uint
%_runtimearr_Instance = OpTypeRuntimeArray %Instance
%OpaqueInstances = OpTypeStruct %_runtimearr_Instance
%_ptr_PhysicalStorageBuffer_OpaqueInstances = OpTypePointer PhysicalStorageBuffer %OpaqueInstances
%_ptr_Function__ptr_PhysicalStorageBuffer_OpaqueInstances = OpTypePointer Function %_ptr_PhysicalStorageBuffer_OpaqueInstances
%IndirectDrawCmd_0 = OpTypeStruct %uint %uint %uint %int %uint
%_ptr_Function_IndirectDrawCmd_0 = OpTypePointer Function %IndirectDrawCmd_0
%_ptr_PhysicalStorageBuffer_IndirectDrawCmd = OpTypePointer PhysicalStorageBuffer %IndirectDrawCmd
 %Instance_0 = OpTypeStruct %uint %uint %uint %uint
%_ptr_Function_Instance_0 = OpTypePointer Function %Instance_0
%vInstanceID = OpVariable %_ptr_Input_uint Input
%_ptr_PhysicalStorageBuffer_Instance = OpTypePointer PhysicalStorageBuffer %Instance
               OpTypeForwardPointer %_ptr_PhysicalStorageBuffer_TransparentIndirectDraws PhysicalStorageBuffer
%IndirectDrawCmd_1 = OpTypeStruct %uint %uint %uint %int %uint
%_runtimearr_IndirectDrawCmd_1 = OpTypeRuntimeArray %IndirectDrawCmd_1
%TransparentIndirectDraws = OpTypeStruct %_runtimearr_IndirectDrawCmd_1
%_ptr_PhysicalStorageBuffer_TransparentIndirectDraws = OpTypePointer PhysicalStorageBuffer %TransparentIndirectDraws
%_ptr_Function__ptr_PhysicalStorageBuffer_TransparentIndirectDraws = OpTypePointer Function %_ptr_PhysicalStorageBuffer_TransparentIndirectDraws
      %int_3 = OpConstant %int 3
               OpTypeForwardPointer %_ptr_PhysicalStorageBuffer_TransparentInstances PhysicalStorageBuffer
 %Instance_1 = OpTypeStruct %uint %uint %uint %uint
%_runtimearr_Instance_1 = OpTypeRuntimeArray %Instance_1
%TransparentInstances = OpTypeStruct %_runtimearr_Instance_1
%_ptr_PhysicalStorageBuffer_TransparentInstances = OpTypePointer PhysicalStorageBuffer %TransparentInstances
%_ptr_Function__ptr_PhysicalStorageBuffer_TransparentInstances = OpTypePointer Function %_ptr_PhysicalStorageBuffer_TransparentInstances
      %int_2 = OpConstant %int 2
%_ptr_PhysicalStorageBuffer_IndirectDrawCmd_1 = OpTypePointer PhysicalStorageBuffer %IndirectDrawCmd_1
%_ptr_PhysicalStorageBuffer_Instance_1 = OpTypePointer PhysicalStorageBuffer %Instance_1
   %Material = OpTypeStruct %v4float %v2float %uint %uint %uint %uint %v3float %float %float %float %float %uint
%_ptr_Function_Material = OpTypePointer Function %Material
%GlobalAddressTableBuffer = OpTypeStruct %GPUAddressTable
%_ptr_StorageBuffer_GlobalAddressTableBuffer = OpTypePointer StorageBuffer %GlobalAddressTableBuffer
        %__0 = OpVariable %_ptr_StorageBuffer_GlobalAddressTableBuffer StorageBuffer
      %int_4 = OpConstant %int 4
               OpTypeForwardPointer %_ptr_PhysicalStorageBuffer_MaterialBuffer PhysicalStorageBuffer
 %Material_0 = OpTypeStruct %v4float %v2float %uint %uint %uint %uint %v3float %float %float %float %float %uint
%_runtimearr_Material_0 = OpTypeRuntimeArray %Material_0
%MaterialBuffer = OpTypeStruct %_runtimearr_Material_0
%_ptr_PhysicalStorageBuffer_MaterialBuffer = OpTypePointer PhysicalStorageBuffer %MaterialBuffer
%_ptr_PhysicalStorageBuffer_Material_0 = OpTypePointer PhysicalStorageBuffer %Material_0
    %uint_16 = OpConstant %uint 16
%_arr_v4float_uint_16 = OpTypeArray %v4float %uint_16
%EnvMapBindingSet = OpTypeStruct %_arr_v4float_uint_16
 %EnvMapData = OpTypeStruct %EnvMapBindingSet
%_ptr_Uniform_EnvMapData = OpTypePointer Uniform %EnvMapData
        %__1 = OpVariable %_ptr_Uniform_EnvMapData Uniform
%_ptr_Uniform_float = OpTypePointer Uniform %float
     %uint_2 = OpConstant %uint 2
%_ptr_Function_v4float = OpTypePointer Function %v4float
%_ptr_Input_v2float = OpTypePointer Input %v2float
       %inUV = OpVariable %_ptr_Input_v2float Input
      %int_5 = OpConstant %int 5
      %int_8 = OpConstant %int 8
      %int_6 = OpConstant %int 6
      %int_7 = OpConstant %int 7
     %uint_3 = OpConstant %uint 3
     %int_10 = OpConstant %int 10
%_ptr_Input_v3float = OpTypePointer Input %v3float
   %inNormal = OpVariable %_ptr_Input_v3float Input
      %int_9 = OpConstant %int 9
%mat4v4float = OpTypeMatrix %v4float 4
  %SceneData = OpTypeStruct %mat4v4float %mat4v4float %mat4v4float %v4float %v4float %v4float %v4float
   %SceneUBO = OpTypeStruct %SceneData
%_ptr_Uniform_SceneUBO = OpTypePointer Uniform %SceneUBO
        %__2 = OpVariable %_ptr_Uniform_SceneUBO Uniform
%_ptr_Uniform_v4float = OpTypePointer Uniform %v4float
    %inColor = OpVariable %_ptr_Input_v3float Input
 %inWorldPos = OpVariable %_ptr_Input_v3float Input
%float_0_0500000007 = OpConstant %float 0.0500000007
%float_0_0399999991 = OpConstant %float 0.0399999991
        %569 = OpConstantComposite %v3float %float_0_0399999991 %float_0_0399999991 %float_0_0399999991
%float_0_00100000005 = OpConstant %float 0.00100000005
        %609 = OpConstantComposite %v3float %float_1 %float_1 %float_1
   %float_10 = OpConstant %float 10
%float_0_454545468 = OpConstant %float 0.454545468
        %680 = OpConstantComposite %v3float %float_0_454545468 %float_0_454545468 %float_0_454545468
  %float_0_5 = OpConstant %float 0.5
        %688 = OpConstantComposite %v3float %float_0_5 %float_0_5 %float_0_5
%_ptr_Output_v4float = OpTypePointer Output %v4float
%outFragColor = OpVariable %_ptr_Output_v4float Output
     %uint_4 = OpConstant %uint 4
     %uint_5 = OpConstant %uint 5
     %uint_6 = OpConstant %uint 6
     %uint_7 = OpConstant %uint 7
     %uint_8 = OpConstant %uint 8
     %uint_9 = OpConstant %uint 9
    %uint_10 = OpConstant %uint 10
    %uint_11 = OpConstant %uint 11
               OpLine %1 70 11
       %main = OpFunction %void None %6
          %8 = OpLabel
     %cmdBuf = OpVariable %_ptr_Function__ptr_PhysicalStorageBuffer_OpaqueIndirectDraws Function
    %instBuf = OpVariable %_ptr_Function__ptr_PhysicalStorageBuffer_OpaqueInstances Function
    %drawCmd = OpVariable %_ptr_Function_IndirectDrawCmd_0 Function
       %inst = OpVariable %_ptr_Function_Instance_0 Function
     %tIndex = OpVariable %_ptr_Function_uint Function
   %cmdBuf_0 = OpVariable %_ptr_Function__ptr_PhysicalStorageBuffer_TransparentIndirectDraws Function
  %instBuf_0 = OpVariable %_ptr_Function__ptr_PhysicalStorageBuffer_TransparentInstances Function
        %mat = OpVariable %_ptr_Function_Material Function
%diffuseIdx_0 = OpVariable %_ptr_Function_uint Function
%specularIdx_0 = OpVariable %_ptr_Function_uint Function
  %brdfIdx_0 = OpVariable %_ptr_Function_uint Function
  %albedoMap = OpVariable %_ptr_Function_v4float Function
   %mrSample = OpVariable %_ptr_Function_v4float Function
  %normalMap = OpVariable %_ptr_Function_v3float Function
         %ao = OpVariable %_ptr_Function_float Function
   %emissive = OpVariable %_ptr_Function_v3float Function
%sampledNormal = OpVariable %_ptr_Function_v3float Function
     %normal = OpVariable %_ptr_Function_v3float Function
 %lightColor = OpVariable %_ptr_Function_v3float Function
   %albedo_0 = OpVariable %_ptr_Function_v3float Function
    %viewDir = OpVariable %_ptr_Function_v3float Function
   %lightDir = OpVariable %_ptr_Function_v3float Function
        %H_2 = OpVariable %_ptr_Function_v3float Function
%roughness_2 = OpVariable %_ptr_Function_float Function
   %metallic = OpVariable %_ptr_Function_float Function
        %NDF = OpVariable %_ptr_Function_float Function
    %param_5 = OpVariable %_ptr_Function_v3float Function
    %param_6 = OpVariable %_ptr_Function_v3float Function
    %param_7 = OpVariable %_ptr_Function_float Function
          %G = OpVariable %_ptr_Function_float Function
    %param_8 = OpVariable %_ptr_Function_v3float Function
    %param_9 = OpVariable %_ptr_Function_v3float Function
   %param_10 = OpVariable %_ptr_Function_v3float Function
   %param_11 = OpVariable %_ptr_Function_float Function
       %F0_0 = OpVariable %_ptr_Function_v3float Function
        %F_0 = OpVariable %_ptr_Function_v3float Function
   %param_12 = OpVariable %_ptr_Function_v3float Function
   %param_13 = OpVariable %_ptr_Function_v3float Function
   %param_14 = OpVariable %_ptr_Function_v3float Function
  %numerator = OpVariable %_ptr_Function_v3float Function
%denominator = OpVariable %_ptr_Function_float Function
   %specular = OpVariable %_ptr_Function_v3float Function
         %kS = OpVariable %_ptr_Function_v3float Function
       %kD_0 = OpVariable %_ptr_Function_v3float Function
      %NdotL = OpVariable %_ptr_Function_float Function
    %diffuse = OpVariable %_ptr_Function_v3float Function
   %param_15 = OpVariable %_ptr_Function_v3float Function
   %param_16 = OpVariable %_ptr_Function_v3float Function
 %irradiance = OpVariable %_ptr_Function_v3float Function
   %param_17 = OpVariable %_ptr_Function_v3float Function
   %param_18 = OpVariable %_ptr_Function_uint Function
%reflectionDiffuse = OpVariable %_ptr_Function_v3float Function
%reflectionSpecular = OpVariable %_ptr_Function_v3float Function
   %param_19 = OpVariable %_ptr_Function_v3float Function
   %param_20 = OpVariable %_ptr_Function_v3float Function
   %param_21 = OpVariable %_ptr_Function_float Function
   %param_22 = OpVariable %_ptr_Function_v3float Function
   %param_23 = OpVariable %_ptr_Function_uint Function
   %param_24 = OpVariable %_ptr_Function_uint Function
    %ambient = OpVariable %_ptr_Function_v3float Function
 %sat_factor = OpVariable %_ptr_Function_float Function
 %finalColor = OpVariable %_ptr_Function_v3float Function
%correctedAmbient = OpVariable %_ptr_Function_v3float Function
               OpLine %1 74 0
        %276 = OpLoad %uint %vDrawID
        %283 = OpAccessChain %_ptr_PushConstant_uint %drawData %int_0
        %284 = OpLoad %uint %283
        %285 = OpULessThan %bool %276 %284
               OpSelectionMerge %287 None
               OpBranchConditional %285 %286 %334
        %286 = OpLabel
               OpLine %1 76 0
        %303 = OpAccessChain %_ptr_StorageBuffer_ulong %_ %int_0 %int_0 %int_1
        %304 = OpLoad %ulong %303
        %305 = OpConvertUToPtr %_ptr_PhysicalStorageBuffer_OpaqueIndirectDraws %304
               OpStore %cmdBuf %305
               OpLine %1 77 0
        %312 = OpAccessChain %_ptr_StorageBuffer_ulong %_ %int_0 %int_0 %int_0
        %313 = OpLoad %ulong %312
        %314 = OpConvertUToPtr %_ptr_PhysicalStorageBuffer_OpaqueInstances %313
               OpStore %instBuf %314
               OpLine %1 79 0
        %318 = OpLoad %_ptr_PhysicalStorageBuffer_OpaqueIndirectDraws %cmdBuf
        %319 = OpLoad %uint %vDrawID
        %321 = OpAccessChain %_ptr_PhysicalStorageBuffer_IndirectDrawCmd %318 %int_0 %319
        %322 = OpLoad %IndirectDrawCmd %321 Aligned 4
        %323 = OpCopyLogical %IndirectDrawCmd_0 %322
               OpStore %drawCmd %323
               OpLine %1 80 0
        %327 = OpLoad %_ptr_PhysicalStorageBuffer_OpaqueInstances %instBuf
        %329 = OpLoad %uint %vInstanceID
        %331 = OpAccessChain %_ptr_PhysicalStorageBuffer_Instance %327 %int_0 %329
        %332 = OpLoad %Instance %331 Aligned 16
        %333 = OpCopyLogical %Instance_0 %332
               OpStore %inst %333
               OpBranch %287
        %334 = OpLabel
               OpLine %1 83 0
        %336 = OpLoad %uint %vDrawID
        %337 = OpAccessChain %_ptr_PushConstant_uint %drawData %int_0
        %338 = OpLoad %uint %337
        %339 = OpISub %uint %336 %338
               OpStore %tIndex %339
               OpLine %1 84 0
        %340 = OpLoad %uint %tIndex
        %341 = OpAccessChain %_ptr_PushConstant_uint %drawData %int_1
        %342 = OpLoad %uint %341
        %343 = OpUGreaterThanEqual %bool %340 %342
               OpSelectionMerge %345 None
               OpBranchConditional %343 %344 %345
        %344 = OpLabel
               OpLine %1 84 0
               OpReturn
        %345 = OpLabel
               OpLine %1 86 0
        %354 = OpAccessChain %_ptr_StorageBuffer_ulong %_ %int_0 %int_0 %int_3
        %355 = OpLoad %ulong %354
        %356 = OpConvertUToPtr %_ptr_PhysicalStorageBuffer_TransparentIndirectDraws %355
               OpStore %cmdBuf_0 %356
               OpLine %1 87 0
        %364 = OpAccessChain %_ptr_StorageBuffer_ulong %_ %int_0 %int_0 %int_2
        %365 = OpLoad %ulong %364
        %366 = OpConvertUToPtr %_ptr_PhysicalStorageBuffer_TransparentInstances %365
               OpStore %instBuf_0 %366
               OpLine %1 89 0
        %367 = OpLoad %_ptr_PhysicalStorageBuffer_TransparentIndirectDraws %cmdBuf_0
        %368 = OpLoad %uint %tIndex
        %370 = OpAccessChain %_ptr_PhysicalStorageBuffer_IndirectDrawCmd_1 %367 %int_0 %368
        %371 = OpLoad %IndirectDrawCmd_1 %370 Aligned 4
        %372 = OpCopyLogical %IndirectDrawCmd_0 %371
               OpStore %drawCmd %372
               OpLine %1 90 0
        %373 = OpLoad %_ptr_PhysicalStorageBuffer_TransparentInstances %instBuf_0
        %374 = OpLoad %uint %vInstanceID
        %376 = OpAccessChain %_ptr_PhysicalStorageBuffer_Instance_1 %373 %int_0 %374
        %377 = OpLoad %Instance_1 %376 Aligned 16
        %378 = OpCopyLogical %Instance_0 %377
               OpStore %inst %378
               OpBranch %287
        %287 = OpLabel
               OpLine %1 93 0
        %386 = OpAccessChain %_ptr_StorageBuffer_ulong %__0 %int_0 %int_0 %int_4
        %387 = OpLoad %ulong %386
        %392 = OpConvertUToPtr %_ptr_PhysicalStorageBuffer_MaterialBuffer %387
        %393 = OpAccessChain %_ptr_Function_uint %inst %int_1
        %394 = OpLoad %uint %393
        %396 = OpAccessChain %_ptr_PhysicalStorageBuffer_Material_0 %392 %int_0 %394
        %397 = OpLoad %Material_0 %396 Aligned 8
        %398 = OpCopyLogical %Material %397
               OpStore %mat %398
               OpLine %1 96 0
        %407 = OpAccessChain %_ptr_Uniform_float %__1 %int_0 %int_0 %int_0 %uint_0
        %408 = OpLoad %float %407
        %409 = OpConvertFToU %uint %408
               OpStore %diffuseIdx_0 %409
               OpLine %1 97 0
        %411 = OpAccessChain %_ptr_Uniform_float %__1 %int_0 %int_0 %int_0 %uint_1
        %412 = OpLoad %float %411
        %413 = OpConvertFToU %uint %412
               OpStore %specularIdx_0 %413
               OpLine %1 98 0
        %416 = OpAccessChain %_ptr_Uniform_float %__1 %int_0 %int_0 %int_0 %uint_2
        %417 = OpLoad %float %416
        %418 = OpConvertFToU %uint %417
               OpStore %brdfIdx_0 %418
               OpLine %1 100 0
        %421 = OpAccessChain %_ptr_Function_uint %mat %int_2
        %422 = OpLoad %uint %421
        %423 = OpCopyObject %uint %422
        %424 = OpAccessChain %_ptr_UniformConstant_244 %combinedSamplers %423
        %425 = OpLoad %244 %424
        %428 = OpLoad %v2float %inUV
        %429 = OpImageSampleImplicitLod %v4float %425 %428
        %430 = OpAccessChain %_ptr_Function_v4float %mat %int_0
        %431 = OpLoad %v4float %430
        %432 = OpFMul %v4float %429 %431
               OpStore %albedoMap %432
               OpLine %1 101 0
        %434 = OpAccessChain %_ptr_Function_uint %mat %int_3
        %435 = OpLoad %uint %434
        %436 = OpCopyObject %uint %435
        %437 = OpAccessChain %_ptr_UniformConstant_244 %combinedSamplers %436
        %438 = OpLoad %244 %437
        %439 = OpLoad %v2float %inUV
        %440 = OpImageSampleImplicitLod %v4float %438 %439
               OpStore %mrSample %440
               OpLine %1 102 0
        %442 = OpAccessChain %_ptr_Function_uint %mat %int_4
        %443 = OpLoad %uint %442
        %444 = OpCopyObject %uint %443
        %445 = OpAccessChain %_ptr_UniformConstant_244 %combinedSamplers %444
        %446 = OpLoad %244 %445
        %447 = OpLoad %v2float %inUV
        %448 = OpImageSampleImplicitLod %v4float %446 %447
        %449 = OpVectorShuffle %v3float %448 %448 0 1 2
               OpStore %normalMap %449
               OpLine %1 103 0
        %452 = OpAccessChain %_ptr_Function_uint %mat %int_5
        %453 = OpLoad %uint %452
        %454 = OpCopyObject %uint %453
        %455 = OpAccessChain %_ptr_UniformConstant_244 %combinedSamplers %454
        %456 = OpLoad %244 %455
        %457 = OpLoad %v2float %inUV
        %458 = OpImageSampleImplicitLod %v4float %456 %457
        %459 = OpCompositeExtract %float %458 0
        %461 = OpAccessChain %_ptr_Function_float %mat %int_8
        %462 = OpLoad %float %461
        %463 = OpFMul %float %459 %462
               OpStore %ao %463
               OpLine %1 105 0
        %466 = OpAccessChain %_ptr_Function_v3float %mat %int_6
        %467 = OpLoad %v3float %466
        %469 = OpAccessChain %_ptr_Function_float %mat %int_7
        %470 = OpLoad %float %469
        %471 = OpVectorTimesScalar %v3float %467 %470
               OpStore %emissive %471
               OpLine %1 107 0
        %473 = OpAccessChain %_ptr_Function_float %albedoMap %uint_3
        %474 = OpLoad %float %473
        %476 = OpAccessChain %_ptr_Function_float %mat %int_10
        %477 = OpLoad %float %476
        %478 = OpFOrdLessThan %bool %474 %477
               OpSelectionMerge %480 None
               OpBranchConditional %478 %479 %480
        %479 = OpLabel
               OpLine %1 107 0
               OpDemoteToHelperInvocation
               OpBranch %480
        %480 = OpLabel
               OpLine %1 109 0
        %482 = OpLoad %v3float %normalMap
        %483 = OpVectorTimesScalar %v3float %482 %float_2
        %484 = OpCompositeConstruct %v3float %float_1 %float_1 %float_1
        %485 = OpFSub %v3float %483 %484
        %486 = OpExtInst %v3float %4 Normalize %485
               OpStore %sampledNormal %486
               OpLine %1 110 0
        %490 = OpLoad %v3float %inNormal
        %491 = OpLoad %v3float %sampledNormal
        %493 = OpAccessChain %_ptr_Function_float %mat %int_9
        %494 = OpLoad %float %493
        %495 = OpCompositeConstruct %v3float %494 %494 %494
        %496 = OpExtInst %v3float %4 FMix %490 %491 %495
        %497 = OpExtInst %v3float %4 Normalize %496
               OpStore %normal %497
               OpLine %1 112 0
        %505 = OpAccessChain %_ptr_Uniform_v4float %__2 %int_0 %int_5
        %506 = OpLoad %v4float %505
        %507 = OpVectorShuffle %v3float %506 %506 0 1 2
        %508 = OpAccessChain %_ptr_Uniform_float %__2 %int_0 %int_5 %uint_3
        %509 = OpLoad %float %508
        %510 = OpVectorTimesScalar %v3float %507 %509
               OpStore %lightColor %510
               OpLine %1 113 0
        %513 = OpLoad %v3float %inColor
        %514 = OpLoad %v4float %albedoMap
        %515 = OpVectorShuffle %v3float %514 %514 0 1 2
        %516 = OpFMul %v3float %513 %515
               OpStore %albedo_0 %516
               OpLine %1 114 0
        %518 = OpAccessChain %_ptr_Uniform_v4float %__2 %int_0 %int_6
        %519 = OpLoad %v4float %518
        %520 = OpVectorShuffle %v3float %519 %519 0 1 2
        %522 = OpLoad %v3float %inWorldPos
        %523 = OpFSub %v3float %520 %522
        %524 = OpExtInst %v3float %4 Normalize %523
               OpStore %viewDir %524
               OpLine %1 115 0
        %526 = OpAccessChain %_ptr_Uniform_v4float %__2 %int_0 %int_4
        %527 = OpLoad %v4float %526
        %528 = OpVectorShuffle %v3float %527 %527 0 1 2
        %529 = OpExtInst %v3float %4 Normalize %528
               OpStore %lightDir %529
               OpLine %1 116 0
        %531 = OpLoad %v3float %viewDir
        %532 = OpLoad %v3float %lightDir
        %533 = OpFAdd %v3float %531 %532
        %534 = OpExtInst %v3float %4 Normalize %533
               OpStore %H_2 %534
               OpLine %1 118 0
        %536 = OpAccessChain %_ptr_Function_float %mrSample %uint_1
        %537 = OpLoad %float %536
        %538 = OpAccessChain %_ptr_Function_float %mat %int_1 %uint_1
        %539 = OpLoad %float %538
        %540 = OpFMul %float %537 %539
        %542 = OpExtInst %float %4 FClamp %540 %float_0_0500000007 %float_1
               OpStore %roughness_2 %542
               OpLine %1 119 0
        %544 = OpAccessChain %_ptr_Function_float %mrSample %uint_2
        %545 = OpLoad %float %544
        %546 = OpAccessChain %_ptr_Function_float %mat %int_1 %uint_0
        %547 = OpLoad %float %546
        %548 = OpFMul %float %545 %547
               OpStore %metallic %548
               OpLine %1 121 0
        %551 = OpLoad %v3float %normal
               OpStore %param_5 %551
        %553 = OpLoad %v3float %H_2
               OpStore %param_6 %553
        %555 = OpLoad %float %roughness_2
               OpStore %param_7 %555
        %556 = OpFunctionCall %float %D_GGX_vf3_vf3_f1_ %param_5 %param_6 %param_7
               OpStore %NDF %556
               OpLine %1 122 0
        %559 = OpLoad %v3float %normal
               OpStore %param_8 %559
        %561 = OpLoad %v3float %viewDir
               OpStore %param_9 %561
        %563 = OpLoad %v3float %lightDir
               OpStore %param_10 %563
        %565 = OpLoad %float %roughness_2
               OpStore %param_11 %565
        %566 = OpFunctionCall %float %G_SCHLICKGGX_SMITH_vf3_vf3_vf3_f1_ %param_8 %param_9 %param_10 %param_11
               OpStore %G %566
               OpLine %1 123 0
        %570 = OpLoad %v3float %albedo_0
        %571 = OpLoad %float %metallic
        %572 = OpCompositeConstruct %v3float %571 %571 %571
        %573 = OpExtInst %v3float %4 FMix %569 %570 %572
               OpStore %F0_0 %573
               OpLine %1 124 0
        %576 = OpLoad %v3float %viewDir
               OpStore %param_12 %576
        %578 = OpLoad %v3float %H_2
               OpStore %param_13 %578
        %580 = OpLoad %v3float %F0_0
               OpStore %param_14 %580
        %581 = OpFunctionCall %v3float %F_SCHLICK_vf3_vf3_vf3_ %param_12 %param_13 %param_14
               OpStore %F_0 %581
               OpLine %1 126 0
        %583 = OpLoad %float %NDF
        %584 = OpLoad %float %G
        %585 = OpFMul %float %583 %584
        %586 = OpLoad %v3float %F_0
        %587 = OpVectorTimesScalar %v3float %586 %585
               OpStore %numerator %587
               OpLine %1 127 0
        %589 = OpLoad %v3float %normal
        %590 = OpLoad %v3float %viewDir
        %591 = OpDot %float %589 %590
        %592 = OpExtInst %float %4 FMax %591 %float_0
        %593 = OpFMul %float %float_4 %592
        %594 = OpLoad %v3float %normal
        %595 = OpLoad %v3float %lightDir
        %596 = OpDot %float %594 %595
        %597 = OpExtInst %float %4 FMax %596 %float_0
        %598 = OpFMul %float %593 %597
               OpStore %denominator %598
               OpLine %1 128 0
        %600 = OpLoad %v3float %numerator
        %601 = OpLoad %float %denominator
        %603 = OpExtInst %float %4 FMax %601 %float_0_00100000005
        %604 = OpCompositeConstruct %v3float %603 %603 %603
        %605 = OpFDiv %v3float %600 %604
               OpStore %specular %605
               OpLine %1 130 0
        %607 = OpLoad %v3float %F_0
               OpStore %kS %607
               OpLine %1 131 0
        %610 = OpLoad %v3float %kS
        %611 = OpFSub %v3float %609 %610
               OpStore %kD_0 %611
               OpLine %1 132 0
        %612 = OpLoad %float %metallic
        %613 = OpFSub %float %float_1 %612
        %614 = OpLoad %v3float %kD_0
        %615 = OpVectorTimesScalar %v3float %614 %613
               OpStore %kD_0 %615
               OpLine %1 134 0
        %617 = OpLoad %v3float %normal
        %618 = OpLoad %v3float %lightDir
        %619 = OpDot %float %617 %618
        %620 = OpExtInst %float %4 FMax %619 %float_0
               OpStore %NdotL %620
               OpLine %1 135 0
        %623 = OpLoad %v3float %kD_0
               OpStore %param_15 %623
        %625 = OpLoad %v3float %albedo_0
               OpStore %param_16 %625
        %626 = OpFunctionCall %v3float %Lambert_vf3_vf3_ %param_15 %param_16
               OpStore %diffuse %626
               OpLine %1 137 0
        %629 = OpLoad %v3float %normal
               OpStore %param_17 %629
        %631 = OpLoad %uint %diffuseIdx_0
               OpStore %param_18 %631
        %632 = OpFunctionCall %v3float %DiffuseIrradiance_vf3_u1_ %param_17 %param_18
               OpStore %irradiance %632
               OpLine %1 138 0
        %634 = OpLoad %v3float %irradiance
        %635 = OpLoad %v3float %albedo_0
        %636 = OpFMul %v3float %634 %635
               OpStore %reflectionDiffuse %636
               OpLine %1 139 0
        %639 = OpLoad %v3float %viewDir
               OpStore %param_19 %639
        %641 = OpLoad %v3float %normal
               OpStore %param_20 %641
        %643 = OpLoad %float %roughness_2
               OpStore %param_21 %643
        %645 = OpLoad %v3float %F_0
               OpStore %param_22 %645
        %647 = OpLoad %uint %specularIdx_0
               OpStore %param_23 %647
        %649 = OpLoad %uint %brdfIdx_0
               OpStore %param_24 %649
        %650 = OpFunctionCall %v3float %SpecularReflection_vf3_vf3_f1_vf3_u1_u1_ %param_19 %param_20 %param_21 %param_22 %param_23 %param_24
               OpStore %reflectionSpecular %650
               OpLine %1 141 0
        %652 = OpLoad %v3float %kD_0
        %653 = OpLoad %v3float %reflectionDiffuse
        %654 = OpLoad %v3float %reflectionSpecular
        %655 = OpFAdd %v3float %653 %654
        %656 = OpFMul %v3float %652 %655
               OpStore %ambient %656
               OpLine %1 142 0
        %659 = OpLoad %float %ao
        %660 = OpExtInst %float %4 FMix %float_10 %float_1 %659
               OpStore %sat_factor %660
               OpLine %1 143 0
        %661 = OpLoad %v3float %albedo_0
        %662 = OpLoad %float %sat_factor
        %663 = OpCompositeConstruct %v3float %662 %662 %662
        %664 = OpExtInst %v3float %4 Pow %661 %663
               OpStore %albedo_0 %664
               OpLine %1 145 0
        %666 = OpLoad %v3float %diffuse
        %667 = OpLoad %v3float %specular
        %668 = OpFAdd %v3float %666 %667
        %669 = OpLoad %v3float %lightColor
        %670 = OpFMul %v3float %668 %669
        %671 = OpLoad %float %NdotL
        %672 = OpVectorTimesScalar %v3float %670 %671
               OpStore %finalColor %672
               OpLine %1 146 0
        %674 = OpLoad %v3float %ambient
        %675 = OpLoad %v3float %ambient
        %676 = OpFAdd %v3float %675 %609
        %677 = OpFDiv %v3float %674 %676
               OpStore %correctedAmbient %677
               OpLine %1 147 0
        %678 = OpLoad %v3float %correctedAmbient
        %681 = OpExtInst %v3float %4 Pow %678 %680
               OpStore %correctedAmbient %681
               OpLine %1 148 0
        %682 = OpLoad %v3float %correctedAmbient
        %683 = OpLoad %v3float %emissive
        %684 = OpFAdd %v3float %682 %683
        %685 = OpLoad %v3float %finalColor
        %686 = OpFAdd %v3float %685 %684
               OpStore %finalColor %686
               OpLine %1 149 0
        %689 = OpLoad %float %ao
        %690 = OpVectorTimesScalar %v3float %688 %689
        %691 = OpLoad %v3float %finalColor
        %692 = OpFAdd %v3float %691 %690
               OpStore %finalColor %692
               OpLine %1 159 0
        %695 = OpLoad %v3float %albedo_0
        %696 = OpAccessChain %_ptr_Function_float %albedoMap %uint_3
        %697 = OpLoad %float %696
        %698 = OpCompositeExtract %float %695 0
        %699 = OpCompositeExtract %float %695 1
        %700 = OpCompositeExtract %float %695 2
        %701 = OpCompositeConstruct %v4float %698 %699 %700 %697
               OpStore %outFragColor %701
               OpLine %1 165 0
               OpReturn
               OpFunctionEnd
               OpLine %3 4 34
%Lambert_vf3_vf3_ = OpFunction %v3float None %12
         %kD = OpFunctionParameter %_ptr_Function_v3float
     %albedo = OpFunctionParameter %_ptr_Function_v3float
         %16 = OpLabel
               OpLine %3 6 0
         %63 = OpLoad %v3float %kD
         %64 = OpLoad %v3float %albedo
         %65 = OpFMul %v3float %63 %64
         %67 = OpCompositeConstruct %v3float %float_3_14159274 %float_3_14159274 %float_3_14159274
         %68 = OpFDiv %v3float %65 %67
               OpReturnValue %68
               OpFunctionEnd
               OpLine %3 9 44
%D_GGX_vf3_vf3_f1_ = OpFunction %float None %18
          %N = OpFunctionParameter %_ptr_Function_v3float
          %H = OpFunctionParameter %_ptr_Function_v3float
  %roughness = OpFunctionParameter %_ptr_Function_float
         %23 = OpLabel
          %a = OpVariable %_ptr_Function_float Function
         %a2 = OpVariable %_ptr_Function_float Function
      %NdotH = OpVariable %_ptr_Function_float Function
     %NdotH2 = OpVariable %_ptr_Function_float Function
        %num = OpVariable %_ptr_Function_float Function
    %premult = OpVariable %_ptr_Function_float Function
      %denom = OpVariable %_ptr_Function_float Function
               OpLine %3 11 0
         %72 = OpLoad %float %roughness
         %73 = OpLoad %float %roughness
         %74 = OpFMul %float %72 %73
               OpStore %a %74
               OpLine %3 12 0
         %76 = OpLoad %float %a
         %77 = OpLoad %float %a
         %78 = OpFMul %float %76 %77
               OpStore %a2 %78
               OpLine %3 13 0
         %80 = OpLoad %v3float %N
         %81 = OpLoad %v3float %H
         %82 = OpDot %float %80 %81
         %84 = OpExtInst %float %4 FMax %82 %float_0
               OpStore %NdotH %84
               OpLine %3 14 0
         %86 = OpLoad %float %NdotH
         %87 = OpLoad %float %NdotH
         %88 = OpFMul %float %86 %87
               OpStore %NdotH2 %88
               OpLine %3 16 0
         %90 = OpLoad %float %a2
               OpStore %num %90
               OpLine %3 17 0
         %92 = OpLoad %float %NdotH2
         %93 = OpLoad %float %a2
         %95 = OpFSub %float %93 %float_1
         %96 = OpFMul %float %92 %95
         %97 = OpFAdd %float %96 %float_1
               OpStore %premult %97
               OpLine %3 18 0
         %99 = OpLoad %float %premult
        %100 = OpFMul %float %float_3_14159274 %99
        %101 = OpLoad %float %premult
        %102 = OpFMul %float %100 %101
               OpStore %denom %102
               OpLine %3 19 0
        %103 = OpLoad %float %num
        %104 = OpLoad %float %denom
        %105 = OpFDiv %float %103 %104
               OpReturnValue %105
               OpFunctionEnd
               OpLine %3 22 40
%G_SCHLICKGGX_f1_f1_ = OpFunction %float None %24
      %NdotX = OpFunctionParameter %_ptr_Function_float
          %k = OpFunctionParameter %_ptr_Function_float
         %28 = OpLabel
      %num_0 = OpVariable %_ptr_Function_float Function
    %denom_0 = OpVariable %_ptr_Function_float Function
               OpLine %3 23 0
        %109 = OpLoad %float %NdotX
               OpStore %num_0 %109
               OpLine %3 24 0
        %111 = OpLoad %float %NdotX
        %112 = OpLoad %float %k
        %113 = OpFSub %float %float_1 %112
        %114 = OpFMul %float %111 %113
        %115 = OpLoad %float %k
        %116 = OpFAdd %float %114 %115
               OpStore %denom_0 %116
               OpLine %3 25 0
        %117 = OpLoad %float %num_0
        %118 = OpLoad %float %denom_0
        %119 = OpFDiv %float %117 %118
               OpReturnValue %119
               OpFunctionEnd
               OpLine %3 29 65
%G_SCHLICKGGX_SMITH_vf3_vf3_vf3_f1_ = OpFunction %float None %29
        %N_0 = OpFunctionParameter %_ptr_Function_v3float
          %V = OpFunctionParameter %_ptr_Function_v3float
          %L = OpFunctionParameter %_ptr_Function_v3float
%roughness_0 = OpFunctionParameter %_ptr_Function_float
         %35 = OpLabel
          %r = OpVariable %_ptr_Function_float Function
        %k_0 = OpVariable %_ptr_Function_float Function
      %NDotV = OpVariable %_ptr_Function_float Function
      %NDotL = OpVariable %_ptr_Function_float Function
       %ggx2 = OpVariable %_ptr_Function_float Function
      %param = OpVariable %_ptr_Function_float Function
    %param_0 = OpVariable %_ptr_Function_float Function
       %ggx1 = OpVariable %_ptr_Function_float Function
    %param_1 = OpVariable %_ptr_Function_float Function
    %param_2 = OpVariable %_ptr_Function_float Function
               OpLine %3 33 0
        %123 = OpLoad %float %roughness_0
        %124 = OpFAdd %float %123 %float_1
               OpStore %r %124
               OpLine %3 34 0
        %126 = OpLoad %float %r
        %127 = OpLoad %float %r
        %128 = OpFMul %float %126 %127
        %130 = OpFDiv %float %128 %float_8
               OpStore %k_0 %130
               OpLine %3 36 0
        %132 = OpLoad %v3float %N_0
        %133 = OpLoad %v3float %V
        %134 = OpDot %float %132 %133
        %135 = OpExtInst %float %4 FMax %134 %float_0
               OpStore %NDotV %135
               OpLine %3 37 0
        %137 = OpLoad %v3float %N_0
        %138 = OpLoad %v3float %L
        %139 = OpDot %float %137 %138
        %140 = OpExtInst %float %4 FMax %139 %float_0
               OpStore %NDotL %140
               OpLine %3 39 0
        %143 = OpLoad %float %NDotV
               OpStore %param %143
        %145 = OpLoad %float %k_0
               OpStore %param_0 %145
        %146 = OpFunctionCall %float %G_SCHLICKGGX_f1_f1_ %param %param_0
               OpStore %ggx2 %146
               OpLine %3 40 0
        %149 = OpLoad %float %NDotL
               OpStore %param_1 %149
        %151 = OpLoad %float %k_0
               OpStore %param_2 %151
        %152 = OpFunctionCall %float %G_SCHLICKGGX_f1_f1_ %param_1 %param_2
               OpStore %ggx1 %152
               OpLine %3 41 0
        %153 = OpLoad %float %ggx1
        %154 = OpLoad %float %ggx2
        %155 = OpFMul %float %153 %154
               OpReturnValue %155
               OpFunctionEnd
               OpLine %3 44 42
%FRESNEL_POWER_UNREAL_vf3_vf3_ = OpFunction %float None %36
        %V_0 = OpFunctionParameter %_ptr_Function_v3float
        %H_0 = OpFunctionParameter %_ptr_Function_v3float
         %40 = OpLabel
      %VDotH = OpVariable %_ptr_Function_float Function
               OpLine %3 45 0
        %159 = OpLoad %v3float %V_0
        %160 = OpLoad %v3float %H_0
        %161 = OpDot %float %159 %160
               OpStore %VDotH %161
               OpLine %3 46 0
        %163 = OpLoad %float %VDotH
        %164 = OpFMul %float %float_n5_55472994 %163
        %166 = OpFSub %float %164 %float_6_98316002
        %167 = OpLoad %float %VDotH
        %168 = OpFMul %float %166 %167
               OpReturnValue %168
               OpFunctionEnd
               OpLine %3 50 39
%F_SCHLICK_vf3_vf3_vf3_ = OpFunction %v3float None %41
        %V_1 = OpFunctionParameter %_ptr_Function_v3float
        %H_1 = OpFunctionParameter %_ptr_Function_v3float
         %F0 = OpFunctionParameter %_ptr_Function_v3float
         %46 = OpLabel
      %VdotH = OpVariable %_ptr_Function_float Function
    %param_3 = OpVariable %_ptr_Function_v3float Function
    %param_4 = OpVariable %_ptr_Function_v3float Function
               OpLine %3 51 0
        %172 = OpLoad %v3float %V_1
        %173 = OpLoad %v3float %H_1
        %174 = OpDot %float %172 %173
        %175 = OpExtInst %float %4 FMax %174 %float_0
               OpStore %VdotH %175
               OpLine %3 57 0
        %176 = OpLoad %v3float %F0
        %177 = OpLoad %v3float %F0
        %178 = OpCompositeConstruct %v3float %float_1 %float_1 %float_1
        %179 = OpFSub %v3float %178 %177
        %182 = OpLoad %v3float %V_1
               OpStore %param_3 %182
        %184 = OpLoad %v3float %H_1
               OpStore %param_4 %184
        %185 = OpFunctionCall %float %FRESNEL_POWER_UNREAL_vf3_vf3_ %param_3 %param_4
        %186 = OpExtInst %float %4 Pow %float_2 %185
        %187 = OpVectorTimesScalar %v3float %179 %186
        %188 = OpFAdd %v3float %176 %187
               OpReturnValue %188
               OpFunctionEnd
               OpLine %1 56 47
%DiffuseIrradiance_vf3_u1_ = OpFunction %v3float None %49
        %N_1 = OpFunctionParameter %_ptr_Function_v3float
 %diffuseIdx = OpFunctionParameter %_ptr_Function_uint
         %53 = OpLabel
      %ENV_N = OpVariable %_ptr_Function_v3float Function
               OpLine %1 57 0
        %192 = OpLoad %v3float %N_1
               OpStore %ENV_N %192
               OpSelectionMerge %196 None
               OpBranchConditional %true %195 %196
        %195 = OpLabel
               OpLine %1 58 0
        %198 = OpAccessChain %_ptr_Function_float %ENV_N %uint_1
        %199 = OpLoad %float %198
        %200 = OpFNegate %float %199
        %201 = OpAccessChain %_ptr_Function_float %ENV_N %uint_1
               OpStore %201 %200
               OpBranch %196
        %196 = OpLabel
               OpLine %1 59 0
        %207 = OpLoad %uint %diffuseIdx
        %208 = OpCopyObject %uint %207
        %210 = OpAccessChain %_ptr_UniformConstant_203 %envMaps %208
        %211 = OpLoad %203 %210
        %212 = OpLoad %v3float %ENV_N
        %214 = OpImageSampleExplicitLod %v4float %211 %212 Lod %float_2
        %215 = OpVectorShuffle %v3float %214 %214 0 1 2
               OpReturnValue %215
               OpFunctionEnd
               OpLine %1 62 96
%SpecularReflection_vf3_vf3_f1_vf3_u1_u1_ = OpFunction %v3float None %54
        %V_2 = OpFunctionParameter %_ptr_Function_v3float
        %N_2 = OpFunctionParameter %_ptr_Function_v3float
%roughness_1 = OpFunctionParameter %_ptr_Function_float
          %F = OpFunctionParameter %_ptr_Function_v3float
%specularIdx = OpFunctionParameter %_ptr_Function_uint
    %brdfIdx = OpFunctionParameter %_ptr_Function_uint
         %62 = OpLabel
          %R = OpVariable %_ptr_Function_v3float Function
%prefilteredColor = OpVariable %_ptr_Function_v3float Function
    %envBRDF = OpVariable %_ptr_Function_v2float Function
               OpLine %1 63 0
        %219 = OpLoad %v3float %V_2
        %220 = OpFNegate %v3float %219
        %221 = OpLoad %v3float %N_2
        %222 = OpExtInst %v3float %4 Reflect %220 %221
               OpStore %R %222
               OpSelectionMerge %224 None
               OpBranchConditional %true %223 %224
        %223 = OpLabel
               OpLine %1 64 0
        %225 = OpAccessChain %_ptr_Function_float %R %uint_1
        %226 = OpLoad %float %225
        %227 = OpFNegate %float %226
        %228 = OpAccessChain %_ptr_Function_float %R %uint_1
               OpStore %228 %227
               OpBranch %224
        %224 = OpLabel
               OpLine %1 65 0
        %230 = OpLoad %uint %specularIdx
        %231 = OpCopyObject %uint %230
        %232 = OpAccessChain %_ptr_UniformConstant_203 %envMaps %231
        %233 = OpLoad %203 %232
        %234 = OpLoad %v3float %R
        %235 = OpLoad %float %roughness_1
        %237 = OpFMul %float %235 %float_4
        %238 = OpImageSampleExplicitLod %v4float %233 %234 Lod %237
        %239 = OpVectorShuffle %v3float %238 %238 0 1 2
               OpStore %prefilteredColor %239
               OpLine %1 66 0
        %248 = OpLoad %uint %brdfIdx
        %249 = OpCopyObject %uint %248
        %251 = OpAccessChain %_ptr_UniformConstant_244 %combinedSamplers %249
        %252 = OpLoad %244 %251
        %253 = OpLoad %v3float %N_2
        %254 = OpLoad %v3float %V_2
        %255 = OpDot %float %253 %254
        %256 = OpExtInst %float %4 FMax %255 %float_0
        %257 = OpLoad %float %roughness_1
        %258 = OpCompositeConstruct %v2float %256 %257
        %259 = OpImageSampleImplicitLod %v4float %252 %258
        %260 = OpVectorShuffle %v2float %259 %259 0 1
               OpStore %envBRDF %260
               OpLine %1 67 0
        %261 = OpLoad %v3float %prefilteredColor
        %262 = OpLoad %v3float %F
        %264 = OpAccessChain %_ptr_Function_float %envBRDF %uint_0
        %265 = OpLoad %float %264
        %266 = OpVectorTimesScalar %v3float %262 %265
        %267 = OpAccessChain %_ptr_Function_float %envBRDF %uint_1
        %268 = OpLoad %float %267
        %269 = OpCompositeConstruct %v3float %268 %268 %268
        %270 = OpFAdd %v3float %266 %269
        %271 = OpFMul %v3float %261 %270
               OpReturnValue %271
               OpFunctionEnd
